<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ–‡ç« è©³æƒ… - éœ²ç‡Ÿè·¯</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/role-system.css" />
    <script src="js/camp-data.js"></script>
    <script src="js/include.js"></script>
    <script>
        // ç¢ºä¿ API å‰ç¶´åœ¨æ‰€æœ‰è…³æœ¬åŸ·è¡Œå‰è¨­ç½®
        if (!window.api_prefix) {
            window.api_prefix = `http://localhost:8081/CJA101G02`;
        }
    </script>
    <style>
        .forum-container {
            padding: 20px 0;
            background-color: #f9f7f4;
        }

        .forum-breadcrumb {
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #666;
        }

        .forum-breadcrumb a {
            color: #3a5a40;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .forum-breadcrumb a:hover {
            color: #a68a64;
        }

        .forum-post-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .forum-post {
            display: flex;
            border-bottom: 1px solid #eee;
        }

        .post-author {
            width: 200px;
            padding: 20px;
            background-color: #f5f5f5;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            align-self: stretch;
        }

        .author-avatar {
            margin-bottom: 15px;
        }

        .author-avatar img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
        }

        .author-name {
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
            margin-bottom: 10px;
            color: #3a5a40;
        }

        .author-level {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .author-stats {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 15px;
            width: auto;
            text-align: left;
            padding-left: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
        }

        .author-stats p {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f0f4ec;
            border-radius: 6px;
            padding: 6px 14px;
            box-shadow: 0 1px 2px rgba(58, 90, 64, 0.04);
            border: 1px solid #e9edc9;
            width: auto;
            min-width: 0;
            max-width: 100%;
        }

        .author-stats span:first-child {
            min-width: 70px;
            color: #3a5a40;
            font-weight: 500;
        }

        .author-stats span:last-child {
            color: #222;
            font-weight: 400;
        }

        .author-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }

        .author-badge {
            display: inline-block;
            padding: 3px 8px;
            background-color: rgba(58, 90, 64, 0.1);
            color: #3a5a40;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .author-camper-badge {
            display: inline-block;
            margin-bottom: 10px;
            padding: 3px 12px;
            background: #e9edc9;
            color: #3a5a40;
            border-radius: 12px;
            font-size: 0.92em;
            font-weight: 500;
            border: 1px solid #b7c9a3;
            margin-top: -2px;
        }

        .post-content {
            flex: 1;
            padding: 20px;
        }

        .post-header {
            margin-bottom: 20px;
        }

        .post-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3a5a40;
            margin-bottom: 10px;
        }

        .delete-article-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .delete-article-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .delete-article-btn i {
            font-size: 0.8rem;
        }

        .post-header {
            position: relative;
        }

        .post-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .post-date {
            display: flex;
            align-items: center;
        }

        .post-date i {
            margin-right: 5px;
        }

        .post-body {
            line-height: 1.6;
            margin-bottom: 20px;
            color: #333;
        }

        .post-body p {
            margin-bottom: 15px;
        }

        /* æ–‡ç« åœ–ç‰‡æ¨£å¼ */
        .post-body img,
        .article-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: block;
            min-height: 50px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .article-image:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .article-image-error {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            padding: 20px;
            text-align: center;
            color: #6c757d;
            border-radius: 8px;
            margin: 15px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .post-body a {
            color: #3a5a40;
            text-decoration: underline;
            transition: color 0.3s ease;
        }

        .post-body a:hover {
            color: #a68a64;
        }

        .post-body h3 {
            color: #3a5a40;
            margin: 25px 0 15px 0;
            font-size: 1.2rem;
        }

        .post-body ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .post-body li {
            margin-bottom: 8px;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .post-reactions {
            display: flex;
            gap: 15px;
        }

        .reaction-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: white;
            color: #666;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .reaction-btn:hover {
            background: #f0f0f0;
            border-color: #bbb;
        }

        .reaction-btn.liked {
            background: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
            color: #dc3545;
        }

        .reaction-btn.favorited {
            background: rgba(255, 193, 7, 0.1);
            border-color: #ffc107;
            color: #ffc107;
        }

        .reaction-btn.favorited i {
            color: #ffc107;
        }

        .reaction-btn.favorited:hover {
            background: rgba(255, 193, 7, 0.2);
        }

        .post-share {
            display: flex;
            gap: 10px;
        }

        .share-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: transform 0.3s ease;
        }

        .share-btn:hover {
            transform: translateY(-2px);
        }

        .share-facebook {
            background: #1877f2;
        }

        .share-line {
            background: #00c300;
        }

        .share-copy {
            background: #666;
        }

        .comments-section {
            margin-top: 30px;
        }

        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9edc9;
        }

        .comments-title {
            color: #3a5a40;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .sort-comments {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .comment-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .comment-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }

        .comment-form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .comment-tools {
            display: flex;
            gap: 10px;
        }

        .tool-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
        }

        .tool-btn:hover {
            background: #e9ecef;
        }

        .btn-submit-comment {
            background: #3a5a40;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-submit-comment:hover {
            background: #2d4731;
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .comment-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .comment-avatar img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .comment-author {
            flex: 1;
        }

        .comment-author-name {
            font-weight: 500;
            color: #3a5a40;
            margin-bottom: 2px;
        }

        .comment-date {
            font-size: 0.85rem;
            color: #666;
        }

        .comment-floor {
            background: #e9edc9;
            color: #3a5a40;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .comment-content {
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .comment-actions {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }

        .comment-action {
            color: #666;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s ease;
        }

        .comment-action:hover {
            color: #3a5a40;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 30px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .page-btn:hover,
        .page-btn.active {
            background: #3a5a40;
            color: white;
            border-color: #3a5a40;
        }

        .page-ellipsis {
            padding: 8px 4px;
            color: #999;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        .prev-btn,
        .next-btn {
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .forum-post {
                flex-direction: column;
            }

            .post-author {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #eee;
            }

            .author-avatar {
                display: flex;
                align-items: center;
                gap: 15px;
                text-align: left;
            }

            .author-avatar img {
                width: 60px;
                height: 60px;
            }

            .author-stats {
                display: flex;
                gap: 20px;
                flex-wrap: wrap;
            }

            .post-actions {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .comment-header {
                flex-wrap: wrap;
            }
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .site-footer,
        footer {
            margin-top: auto;
        }

        /* åœ–ç‰‡è¼‰å…¥ä¸­ç‹€æ…‹ */
        .article-image.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* åœ–ç‰‡è¼‰å…¥å¤±æ•—ç‹€æ…‹ */
        .article-image.error {
            background: #fff5f5;
            border: 2px dashed #feb2b2;
            color: #c53030;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            font-size: 0.9rem;
        }

        /* ç•™è¨€åœ–ç‰‡é è¦½æ¨£å¼ */
        .image-preview-item {
            position: relative;
            display: inline-block;
            width: 80px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid #e9ecef;
            background: #f8f9fa;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-image {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .image-preview-item .remove-image:hover {
            background: #c82333;
        }

        /* æ‹–æ‹½å€åŸŸæ¨£å¼ */
        .comment-form.drag-over {
            border: 2px dashed #3A5A40 !important;
            background: rgba(58, 90, 64, 0.05) !important;
        }

        .comment-form.drag-over::before {
            content: " æ‹–æ‹½åœ–ç‰‡åˆ°æ­¤è™•ä¸Šå‚³";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(58, 90, 64, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 10;
        }

        /* ç•™è¨€ä¸­çš„åœ–ç‰‡é¡¯ç¤º */
        .comment-images {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .comment-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 6px;
            cursor:
                pointer;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .comment-image:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* åœ–ç‰‡ç‡ˆç®± */
        .image-lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content:
                center;
            z-index: 1000;
            cursor: pointer;
        }

        .image-lightbox img {
            max-width: 100%;
            max-height: 100%;
            object-fit:
                contain;
            border-radius: 8px;
        }

        .image-lightbox .close-lightbox {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor:
                pointer;
            font-size: 1.2rem;
            color: #333;
        }

        /* ä¿®æ­£ç•™è¨€ç·¨è¼¯åœ–ç‰‡é è¦½æ­£æ–¹å½¢æ¯”ä¾‹ */
        .edit-image-preview-item {
            aspect-ratio: 1;
            width: 100px;
            max-width: 100px;
            height: auto;
            min-width: 80px;
            min-height: 80px;
            display: block;
        }
    </style>
</head>

<body>
    <div id="header-container"></div>

    <nav class="forum-breadcrumb" style="margin: 16px 0 0 0; padding-left: 24px; font-size: 0.98rem;">
        <a href="index.html">é¦–é </a> &gt; <a href="article-type.html">è«–å£‡æ”»ç•¥</a> &gt; <span>æ–‡ç« æ¨™é¡Œè¼‰å…¥ä¸­...</span>
    </nav>

    <main class="forum-container">
        <div class="container">
            <div class="forum-post-container">
                <div class="forum-post">
                    <div class="post-author">
                        <div class="author-avatar">
                            <img src="images/user-1.jpg" alt="ä½œè€…é ­åƒ" id="article-author-avatar" style="display:none;" />
                        </div>
                        <div class="author-name">è¼‰å…¥ä¸­...</div>
                        <div class="author-camper-badge" style="display:none;">éœ²ç‡Ÿè€…</div>
                        <div class="author-stats">
                            <p><span>æœƒå“¡ç·¨è™Ÿ:</span> <span>è¼‰å…¥ä¸­...</span></p>
                            <p><span>ç™¼æ–‡æ•¸:</span> <span>è¼‰å…¥ä¸­...</span></p>
                            <p><span>è¨»å†Šæ™‚é–“:</span> <span>è¼‰å…¥ä¸­...</span></p>
                        </div>
                    </div>
                    <div class="post-content">
                        <div class="post-header">
                            <h1 class="post-title">æ–‡ç« æ¨™é¡Œè¼‰å…¥ä¸­...</h1>
                            <div class="article-id" style="color:#888;font-size:0.95em;margin-bottom:8px;">æ–‡ç« ç·¨è™Ÿï¼š<span
                                    id="article-acid">è¼‰å…¥ä¸­...</span></div>
                            <div class="post-meta">
                                <div class="post-date">
                                    <i class="fas fa-calendar"></i>
                                    ç™¼å¸ƒæ™‚é–“ï¼šè¼‰å…¥ä¸­...
                                </div>
                                <div class="post-stats">
                                    <span><i class="fas fa-eye"></i> <span class="view-count">0</span> æ¬¡ç€è¦½</span>
                                </div>
                            </div>
                        </div>

                        <div class="post-body">
                            <!-- æ–‡ç« å…§å®¹å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
                            <p>è¼‰å…¥ä¸­...</p>
                        </div>

                        <div class="post-actions">
                            <div class="post-reactions">
                                <button class="reaction-btn like-article-btn"><i class="fas fa-thumbs-up"></i>
                                    <span>æŒ‰è®š</span><span class="like-count"
                                        style="margin-left:8px;color:#dc3545;font-weight:500;">0</span></button>
                                <button class="reaction-btn" id="favorite-btn" data-article-id="">
                                    <i class="fas fa-bookmark"></i>
                                    <span>æ”¶è—</span>
                                </button>
                            </div>
                            <div class="post-share">
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div class="comments-section">
                <div class="comments-header">
                    <h3 class="comments-title">ç•™è¨€è¨è«– (12)</h3>
                    <select class="sort-comments">
                        <option value="newest">æœ€æ–°å›è¦†</option>
                        <option value="oldest">æœ€æ—©å›è¦†</option>
                    </select>
                </div>

                <!-- æœªç™»å…¥æç¤º -->
                <div id="login-required-message"
                    style="display: none; text-align: center; padding: 30px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                    <i class="fas fa-user-lock"
                        style="font-size: 2rem; color: #6c757d; margin-bottom: 15px; display: block;"></i>
                    <h4 style="color: #495057; margin-bottom: 10px;">è«‹ç™»å…¥å¾Œå†ç™¼è¡¨ç•™è¨€</h4>
                    <p style="color: #6c757d; margin-bottom: 20px;">ç™»å…¥å¾Œå³å¯åƒèˆ‡è¨è«–ï¼Œåˆ†äº«æ‚¨çš„éœ²ç‡Ÿç¶“é©—</p>
                    <a href="login.html?redirect=" + encodeURIComponent(window.location.href) + ""
                        style="background: #3A5A40; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; display: inline-block; transition: background 0.3s ease;">ç«‹å³ç™»å…¥</a>
                </div>

                <div class="comment-form" id="comment-form-container">
                    <div id="reply-info"></div>
                    <textarea id="reply-textarea" placeholder="åˆ†äº«ä½ çš„éœ²ç‡Ÿç¶“é©—æˆ–æå‡ºå•é¡Œ..."></textarea>

                    <!-- åœ–ç‰‡é è¦½å€åŸŸ -->
                    <div id="image-preview-container"
                        style="display: none; margin: 10px 0; padding: 10px; border: 1px dashed #ddd; border-radius: 4px;">
                        <div class="preview-header"
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 0.9rem; color: #666;">ğŸ“· å·²é¸æ“‡çš„åœ–ç‰‡ (<span
                                    id="image-count">0</span>/5)</span>
                            <button type="button" id="clear-all-images"
                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem; cursor: pointer;">æ¸…é™¤å…¨éƒ¨</button>
                        </div>
                        <div id="image-preview-list" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                    </div>

                    <div class="comment-form-actions">
                        <div class="comment-tools">
                            <button type="button" class="tool-btn" id="upload-image-btn" title="ä¸Šå‚³åœ–ç‰‡"><i
                                    class="fas fa-image"></i></button>
                            <input type="file" id="image-file-input" accept="image/*" multiple style="display: none;">
                            <span style="font-size: 0.8rem; color: #666; margin-left: 10px;">æ”¯æ´æ‹–æ‹½ã€ç²˜è²¼æˆ–é¸æ“‡åœ–ç‰‡ (æœ€å¤š5å¼µ)</span>
                        </div>
                        <button type="button" class="btn-submit-comment" id="submit-reply-btn">ç™¼å¸ƒç•™è¨€</button>
                    </div>
                </div>

                <div class="comments-list">
                    <!-- ç•™è¨€å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
                    <div style="text-align: center; padding: 20px; color: #666;">è¼‰å…¥ç•™è¨€ä¸­...</div>
                </div>

                <div class="pagination">
                    <a href="#" class="page-btn active">1</a>
                    <a href="#" class="page-btn">2</a>
                    <a href="#" class="page-btn">3</a>
                    <a href="#" class="page-btn">ä¸‹ä¸€é </a>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-container"></div>

    <script src="js/main.js"></script>
    <!-- <script src="js/article-display.js"></script> -->
    <script src="js/articles.js"></script>
    <script src="js/header-auth.js"></script>

    <script>
        // æ–‡ç« æ”¶è—åŠŸèƒ½
        class ArticleFavoriteManager {
            constructor() {
                this.currentMember = null;
                this.currentArticleId = null;
                this.favoriteBtn = null;
                this.init();
            }

            init() {
                this.checkLoginStatus();
                this.setupFavoriteButton();
                this.setupLoginStateListener();
            }

            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            checkLoginStatus() {
                const memberData = localStorage.getItem("currentMember") || sessionStorage.getItem("currentMember");
                if (memberData) {
                    this.currentMember = JSON.parse(memberData);
                    return true; // è¿”å›ç™»å…¥ç‹€æ…‹
                }
                return false; // æœªç™»å…¥
            }

            // è¨­ç½®æ”¶è—æŒ‰éˆ•
            setupFavoriteButton() {
                this.favoriteBtn = document.getElementById('favorite-btn');
                if (this.favoriteBtn) {
                    // å¾URLç²å–æ–‡ç« ID
                    this.currentArticleId = new URLSearchParams(window.location.search).get('id');
                    this.favoriteBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleFavoriteClick();
                    });
                }
            }

            // è™•ç†æ”¶è—æŒ‰éˆ•é»æ“Š
            async handleFavoriteClick() {
                if (!this.currentMember) {
                    this.showLoginPrompt();
                    return;
                }

                if (!this.currentArticleId) {
                    console.error('æ–‡ç« IDæœªè¨­ç½®');
                    return;
                }

                try {
                    const isFavorited = this.favoriteBtn.classList.contains('favorited');

                    if (isFavorited) {
                        await this.removeFavorite();
                    } else {
                        await this.addFavorite();
                    }
                } catch (error) {
                    console.error('æ”¶è—æ“ä½œå¤±æ•—:', error);
                    this.showMessage('æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                }
            }

            // æ–°å¢æ”¶è—
            async addFavorite() {
                // æª¢æŸ¥æœƒå“¡è³‡æ–™å®Œæ•´æ€§
                if (!this.currentMember) {
                    console.error('æœƒå“¡è³‡æ–™ä¸å­˜åœ¨');
                    this.showMessage('è«‹å…ˆç™»å…¥', 'error');
                    return;
                }

                // æª¢æŸ¥æœƒå“¡IDï¼Œæ”¯æ´å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±
                const memId = this.currentMember.mem_id || this.currentMember.memId || this.currentMember.id;
                if (!memId) {
                    console.error('æœƒå“¡IDä¸å­˜åœ¨ï¼Œæœƒå“¡è³‡æ–™:', this.currentMember);
                    this.showMessage('æœƒå“¡è³‡æ–™ä¸å®Œæ•´ï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
                    return;
                }

                // console.log('æº–å‚™ç™¼é€æ”¶è—è«‹æ±‚ï¼Œæœƒå“¡è³‡æ–™:', {  // å·²éš±è—èª¿è©¦è¼¸å‡º
                //     currentMember: this.currentMember,
                //     memId: memId,
                //     articleId: this.currentArticleId
                // });

                try {
                    // ä½¿ç”¨å¾Œç«¯æœŸæœ›çš„æ•¸æ“šæ ¼å¼ (camelCase)
                    const favoriteData = {
                        acId: parseInt(this.currentArticleId),
                        memId: parseInt(memId),
                        acFavTime: new Date().toISOString().slice(0, 19) // ä¿æŒISOæ ¼å¼ï¼Œä¸æ›¿æ›T
                    };

                    // console.log('ç™¼é€æ”¶è—è«‹æ±‚:', favoriteData); // å·²éš±è—èª¿è©¦è¼¸å‡º

                    const response = await fetch(`${window.api_prefix}/api/favorites`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(favoriteData)
                    });

                    const result = await response.json();
                    // console.log('APIå›æ‡‰:', result); // å·²éš±è—èª¿è©¦è¼¸å‡º

                    if (response.ok && result.status === 'success') {
                        this.favoriteBtn.classList.add('favorited');
                        this.favoriteBtn.querySelector('span').textContent = 'å·²æ”¶è—';
                        this.showMessage('æ”¶è—æˆåŠŸï¼', 'success');

                        // å„²å­˜åˆ°localStorageä½œç‚ºå‚™ç”¨
                        this.saveToLocalStorage(favoriteData);
                    } else {
                        // å¦‚æœAPIå¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬æ”¶è—
                        // console.log('APIå¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬æ”¶è—'); // å·²éš±è—èª¿è©¦è¼¸å‡º
                        this.simulateFavorite(favoriteData);
                    }
                } catch (error) {
                    // console.error('æ”¶è—APIèª¿ç”¨å¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬æ”¶è—:', error); // å·²éš±è—èª¿è©¦è¼¸å‡º
                    const favoriteData = {
                        acId: parseInt(this.currentArticleId),
                        memId: parseInt(memId),
                        acFavTime: new Date().toISOString().slice(0, 19).replace('T', ' ')
                    };
                    this.simulateFavorite(favoriteData);
                }
            }

            // æ¨¡æ“¬æ”¶è—åŠŸèƒ½
            simulateFavorite(favoriteData) {
                this.favoriteBtn.classList.add('favorited');
                this.favoriteBtn.querySelector('span').textContent = 'å·²æ”¶è—';
                this.showMessage('æ”¶è—æˆåŠŸï¼(æ¨¡æ“¬)', 'success');

                // å„²å­˜åˆ°localStorage
                this.saveToLocalStorage(favoriteData);
            }

            // å„²å­˜åˆ°localStorage
            saveToLocalStorage(favoriteData) {
                const favorites = JSON.parse(localStorage.getItem('articleFavorites') || '[]');
                const existingIndex = favorites.findIndex(fav =>
                    fav.memId === favoriteData.memId && fav.acId === favoriteData.acId
                );

                if (existingIndex === -1) {
                    favorites.push(favoriteData);
                    localStorage.setItem('articleFavorites', JSON.stringify(favorites));
                    // console.log('æ”¶è—å·²å„²å­˜åˆ°localStorage'); // å·²éš±è—èª¿è©¦è¼¸å‡º
                }
            }

            // å–æ¶ˆæ”¶è—
            async removeFavorite() {
                // æª¢æŸ¥æœƒå“¡è³‡æ–™å®Œæ•´æ€§
                if (!this.currentMember) {
                    console.error('æœƒå“¡è³‡æ–™ä¸å­˜åœ¨');
                    this.showMessage('è«‹å…ˆç™»å…¥', 'error');
                    return;
                }

                // æª¢æŸ¥æœƒå“¡IDï¼Œæ”¯æ´å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±
                const memId = this.currentMember.mem_id || this.currentMember.memId || this.currentMember.id;
                if (!memId) {
                    console.error('æœƒå“¡IDä¸å­˜åœ¨ï¼Œç„¡æ³•å¾localStorageç§»é™¤æ”¶è—');
                    return;
                }

                // console.log('ç™¼é€å–æ¶ˆæ”¶è—è«‹æ±‚:', {  // å·²éš±è—èª¿è©¦è¼¸å‡º
                //     memId: memId,
                //     acId: this.currentArticleId
                // });

                try {
                    const response = await fetch(`${window.api_prefix}/api/favorites/${memId}/${this.currentArticleId}`, {
                        method: 'DELETE'
                    });

                    // console.log('å–æ¶ˆæ”¶è—APIå›æ‡‰ç‹€æ…‹:', response.status); // å·²éš±è—èª¿è©¦è¼¸å‡º
                    const result = await response.json();
                    // console.log('å–æ¶ˆæ”¶è—APIå›æ‡‰å…§å®¹:', result); // å·²éš±è—èª¿è©¦è¼¸å‡º

                    if (response.ok && result.status === 'success') {
                        this.favoriteBtn.classList.remove('favorited');
                        this.favoriteBtn.querySelector('span').textContent = 'æ”¶è—';
                        this.showMessage('å·²å–æ¶ˆæ”¶è—', 'success');

                        // å¾localStorageç§»é™¤
                        this.removeFromLocalStorage();
                    } else {
                        // å¦‚æœAPIå¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬å–æ¶ˆæ”¶è—
                        // console.log('APIå¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬å–æ¶ˆæ”¶è—'); // å·²éš±è—èª¿è©¦è¼¸å‡º
                        this.simulateUnfavorite();
                    }
                } catch (error) {
                    // console.error('å–æ¶ˆæ”¶è—APIèª¿ç”¨å¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬å–æ¶ˆæ”¶è—:', error); // å·²éš±è—èª¿è©¦è¼¸å‡º
                    this.simulateUnfavorite();
                }
            }

            // æ¨¡æ“¬å–æ¶ˆæ”¶è—
            simulateUnfavorite() {
                this.favoriteBtn.classList.remove('favorited');
                this.favoriteBtn.querySelector('span').textContent = 'æ”¶è—';
                this.showMessage('å·²å–æ¶ˆæ”¶è—(æ¨¡æ“¬)', 'success');

                // å¾localStorageç§»é™¤
                this.removeFromLocalStorage();
            }

            // å¾localStorageç§»é™¤
            removeFromLocalStorage() {
                // æª¢æŸ¥æœƒå“¡IDï¼Œæ”¯æ´å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±
                const memId = this.currentMember.mem_id || this.currentMember.memId || this.currentMember.id;
                if (!memId) {
                    console.error('æœƒå“¡IDä¸å­˜åœ¨ï¼Œç„¡æ³•å¾localStorageç§»é™¤æ”¶è—');
                    return;
                }

                const favorites = JSON.parse(localStorage.getItem('articleFavorites') || '[]');
                const filteredFavorites = favorites.filter(fav =>
                    !(fav.memId === memId && fav.acId === parseInt(this.currentArticleId))
                );
                localStorage.setItem('articleFavorites', JSON.stringify(filteredFavorites));
                // console.log('æ”¶è—å·²å¾localStorageç§»é™¤'); // å·²éš±è—èª¿è©¦è¼¸å‡º
            }

            // æª¢æŸ¥æ”¶è—ç‹€æ…‹
            async checkFavoriteStatus() {
                if (!this.currentMember || !this.currentArticleId) {
                    // console.log('ç„¡æ³•æª¢æŸ¥æ”¶è—ç‹€æ…‹: ç¼ºå°‘æœƒå“¡è³‡è¨Šæˆ–æ–‡ç« ID'); // å·²éš±è—èª¿è©¦è¼¸å‡º
                    return;
                }

                // æª¢æŸ¥æœƒå“¡IDï¼Œæ”¯æ´å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±
                const memId = this.currentMember.mem_id || this.currentMember.memId || this.currentMember.id;
                if (!memId) {
                    console.error('æœƒå“¡IDä¸å­˜åœ¨ï¼Œæœƒå“¡è³‡æ–™:', this.currentMember);
                    return;
                }

                // console.log('æª¢æŸ¥æ”¶è—ç‹€æ…‹:', {  // å·²éš±è—èª¿è©¦è¼¸å‡º
                //     memId: memId,
                //     acId: this.currentArticleId
                // });

                // å…ˆæª¢æŸ¥localStorageä¸­çš„æ¨¡æ“¬æ”¶è—
                const localFavorites = JSON.parse(localStorage.getItem('articleFavorites') || '[]');
                const isLocalFavorited = localFavorites.some(fav =>
                    fav.memId === memId && fav.acId === parseInt(this.currentArticleId)
                );

                if (isLocalFavorited) {
                    this.favoriteBtn.classList.add('favorited');
                    this.favoriteBtn.querySelector('span').textContent = 'å·²æ”¶è—';
                    // console.log('æ–‡ç« å·²åœ¨localStorageä¸­æ”¶è—'); // å·²éš±è—èª¿è©¦è¼¸å‡º
                    return;
                }

                try {
                    // ä½¿ç”¨æ›´é«˜æ•ˆçš„ check API ç›´æ¥æŸ¥è©¢ç‰¹å®šæ–‡ç« çš„æ”¶è—ç‹€æ…‹
                    const response = await fetch(`${window.api_prefix}/api/favorites/check?acId=${this.currentArticleId}&memId=${memId}`);
                    // console.log('æª¢æŸ¥æ”¶è—ç‹€æ…‹APIå›æ‡‰:', response.status); // å·²éš±è—èª¿è©¦è¼¸å‡º

                    const result = await response.json();
                    // console.log('æ”¶è—ç‹€æ…‹æª¢æŸ¥çµæœ:', result); // å·²éš±è—èª¿è©¦è¼¸å‡º

                    if (response.ok && result.status === 'success') {
                        const isFavorited = result.data; // ç›´æ¥å–å¾—å¸ƒæ—å€¼

                        if (isFavorited) {
                            this.favoriteBtn.classList.add('favorited');
                            this.favoriteBtn.querySelector('span').textContent = 'å·²æ”¶è—';
                            // console.log('æ–‡ç« å·²æ”¶è—'); // å·²éš±è—èª¿è©¦è¼¸å‡º
                        } else {
                            this.favoriteBtn.classList.remove('favorited');
                            this.favoriteBtn.querySelector('span').textContent = 'æ”¶è—';
                            // console.log('æ–‡ç« æœªæ”¶è—'); // å·²éš±è—èª¿è©¦è¼¸å‡º
                        }
                    } else {
                        console.error('æª¢æŸ¥æ”¶è—ç‹€æ…‹APIå›æ‡‰éŒ¯èª¤:', result);
                        // å¦‚æœ check API å¤±æ•—ï¼Œå›é€€åˆ°åŸæœ¬çš„æ–¹å¼
                        this.fallbackCheckFavoriteStatus(memId);
                    }
                } catch (error) {
                    console.error('æª¢æŸ¥æ”¶è—ç‹€æ…‹å¤±æ•—:', error);
                    // å¦‚æœ check API å¤±æ•—ï¼Œå›é€€åˆ°åŸæœ¬çš„æ–¹å¼
                    this.fallbackCheckFavoriteStatus(memId);
                }
            }

            // å›é€€æ–¹æ³•ï¼šä½¿ç”¨åŸæœ¬çš„æ–¹å¼æª¢æŸ¥æ”¶è—ç‹€æ…‹
            async fallbackCheckFavoriteStatus(memId) {
                try {
                    // ç²å–æ‰€æœ‰æ”¶è—è¨˜éŒ„ï¼Œç„¶å¾Œæª¢æŸ¥ç•¶å‰æ–‡ç« æ˜¯å¦åœ¨å…¶ä¸­
                    const response = await fetch(`${window.api_prefix}/api/favorites`);
                    const result = await response.json();

                    if (response.ok && result.status === 'success' && result.data) {
                        // æª¢æŸ¥ç•¶å‰æ–‡ç« æ˜¯å¦åœ¨æ”¶è—åˆ—è¡¨ä¸­
                        const isFavorited = result.data.some(favorite => {
                            const memMatch = favorite.memId === memId;
                            const acMatch = favorite.acId === parseInt(this.currentArticleId);
                            return memMatch && acMatch;
                        });

                        if (isFavorited) {
                            this.favoriteBtn.classList.add('favorited');
                            this.favoriteBtn.querySelector('span').textContent = 'å·²æ”¶è—';
                        } else {
                            this.favoriteBtn.classList.remove('favorited');
                            this.favoriteBtn.querySelector('span').textContent = 'æ”¶è—';
                        }
                    } else {
                        console.error('å›é€€æª¢æŸ¥æ”¶è—ç‹€æ…‹å¤±æ•—:', result);
                    }
                } catch (error) {
                    console.error('å›é€€æª¢æŸ¥æ”¶è—ç‹€æ…‹å¤±æ•—:', error);
                }
            }

            // è¨­ç½®ç•¶å‰æ–‡ç« ID
            setCurrentArticleId(articleId) {
                this.currentArticleId = articleId;
                if (this.favoriteBtn) {
                    this.favoriteBtn.setAttribute('data-article-id', articleId);
                }
                // è¨­ç½®æ–‡ç« IDå¾Œç«‹å³æª¢æŸ¥æ”¶è—ç‹€æ…‹
                this.checkFavoriteStatus();
            }

            // é¡¯ç¤ºç™»å…¥æç¤º
            showLoginPrompt() {
                this.showMessage('è«‹å…ˆç™»å…¥æ‰èƒ½æ”¶è—æ–‡ç« ', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }

            // é¡¯ç¤ºè¨Šæ¯
            showMessage(message, type) {
                // å‰µå»ºè¨Šæ¯å…ƒç´ 
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = message;
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 6px;
                    color: white;
                    font-weight: 500;
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                `;

                // æ ¹æ“šé¡å‹è¨­ç½®èƒŒæ™¯è‰²
                switch (type) {
                    case 'success':
                        messageDiv.style.backgroundColor = '#28a745';
                        break;
                    case 'error':
                        messageDiv.style.backgroundColor = '#dc3545';
                        break;
                    case 'warning':
                        messageDiv.style.backgroundColor = '#ffc107';
                        messageDiv.style.color = '#212529';
                        break;
                    default:
                        messageDiv.style.backgroundColor = '#6c757d';
                }

                // æ·»åŠ åˆ°é é¢
                document.body.appendChild(messageDiv);

                // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
                setTimeout(() => {
                    messageDiv.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 300);
                }, 3000);
            }

            // ç›£è½ç™»å…¥ç‹€æ…‹è®ŠåŒ–
            setupLoginStateListener() {
                let previousLoginState = !!this.currentMember;

                setInterval(() => {
                    // ç›´æ¥æª¢æŸ¥localStorageå’ŒsessionStorage
                    const memberData = localStorage.getItem("currentMember") || sessionStorage.getItem("currentMember");
                    const currentLoginState = !!memberData;

                    if (previousLoginState !== currentLoginState) {
                        if (currentLoginState) {
                            this.currentMember = JSON.parse(memberData);
                        } else {
                            this.currentMember = null;
                        }

                        if (this.currentArticleId) {
                            this.checkFavoriteStatus();
                        }
                    }

                    previousLoginState = currentLoginState;
                }, 1000);
            }
        }

        // æ·»åŠ å‹•ç•«æ¨£å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // åˆå§‹åŒ–ç®¡ç†å™¨ï¼ˆç¢ºä¿åªåŸ·è¡Œä¸€æ¬¡ï¼‰
        let managersInitialized = false;
        let favoriteManager;
        let articleDisplayManager;

        // ç•¶æ–‡ç« è¼‰å…¥å®Œæˆå¾Œè¨­ç½®æ–‡ç« ID
        document.addEventListener('DOMContentLoaded', function () {
            if (managersInitialized) return;
            managersInitialized = true;

            // åˆå§‹åŒ–æ”¶è—ç®¡ç†å™¨
            favoriteManager = new ArticleFavoriteManager();

            // ç­‰å¾… ArticleDisplayManager é¡åˆ¥è¼‰å…¥å®Œæˆ
            const waitForArticleDisplayManager = setInterval(() => {
                if (window.ArticleDisplayManager) {
                    // console.log('ArticleDisplayManager é¡åˆ¥å·²è¼‰å…¥'); // å·²éš±è—èª¿è©¦è¼¸å‡º

                    // åˆå§‹åŒ–æ–‡ç« é¡¯ç¤ºç®¡ç†å™¨
                    try {
                        articleDisplayManager = new window.ArticleDisplayManager();
                        window.articleDisplayManager = articleDisplayManager;
                        // console.log('ArticleDisplayManager å¯¦ä¾‹å·²å»ºç«‹ï¼Œé–‹å§‹è¼‰å…¥æ–‡ç« ...'); // å·²éš±è—èª¿è©¦è¼¸å‡º
                    } catch (error) {
                        console.error('ArticleDisplayManager å¯¦ä¾‹å»ºç«‹å¤±æ•—:', error);
                    }

                    clearInterval(waitForArticleDisplayManager);

                    // ç­‰å¾…æ–‡ç« é¡¯ç¤ºç®¡ç†å™¨è¼‰å…¥å®Œæˆ
                    const checkArticleLoaded = setInterval(() => {
                        if (window.articleDisplayManager && window.articleDisplayManager.getCurrentArticleId()) {
                            const articleId = window.articleDisplayManager.getCurrentArticleId();
                            // console.log('æ–‡ç« IDå·²å–å¾—:', articleId); // å·²éš±è—èª¿è©¦è¼¸å‡º
                            favoriteManager.setCurrentArticleId(articleId);
                            clearInterval(checkArticleLoaded);
                        } else if (window.articleDisplayManager) {
                            // å¦‚æœå¯¦ä¾‹å­˜åœ¨ä½†æ–‡ç« é‚„æ²’è¼‰å…¥ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
                            // console.log('ArticleDisplayManager å¯¦ä¾‹å­˜åœ¨ï¼Œä½†æ–‡ç« å°šæœªè¼‰å…¥...'); // å·²éš±è—èª¿è©¦è¼¸å‡º
                        }
                    }, 100);
                }
            }, 50);
        });
    </script>
    <script>
        // åˆå§‹åŒ–é ­åƒï¼ˆéš±è—ç‹€æ…‹ï¼Œç­‰å¾…çœŸå¯¦é ­åƒè¼‰å…¥ï¼‰
        document.addEventListener('DOMContentLoaded', function () {
            const authorAvatarImg = document.getElementById('article-author-avatar');
            if (authorAvatarImg) {
                console.log('ğŸ­ è¨­ç½®é è¨­é ­åƒï¼Œç­‰å¾…APIè¼‰å…¥çœŸå¯¦é ­åƒ');

                // åˆå§‹éš±è—é ­åƒï¼Œé¿å…é–ƒçˆ
                authorAvatarImg.style.display = 'none';

                // è¨­ç½®éš¨æ©Ÿ user- åœ–ç‰‡ä½œç‚ºåˆå§‹å€¼
                const randomUserImg = `images/user-${Math.floor(Math.random() * 4) + 1}.jpg`;
                authorAvatarImg.src = randomUserImg;

                // é‡ç½®æ›´æ–°æ¨™è¨˜
                authorAvatarImg.dataset.avatarUpdated = 'false';

                // ç›£è½srcè®ŠåŒ–ï¼Œé˜²æ­¢è¢«å…¶ä»–è…³æœ¬ä¿®æ”¹ç‚ºéé æœŸåœ–ç‰‡
                const observer = new MutationObserver(function (mutations) {
                    mutations.forEach(function (mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
                            const newSrc = authorAvatarImg.src;
                            // å¦‚æœè¢«è¨­å®šç‚ºéé æœŸåœ–ç‰‡ï¼ˆä¸æ˜¯API URLã€ä¸æ˜¯user-åœ–ç‰‡ï¼‰ï¼Œå‰‡é˜»æ­¢
                            if (newSrc &&
                                !newSrc.includes('/member/') &&
                                !newSrc.includes('user-')) {
                                console.log('ğŸš« é˜»æ­¢è¨­å®šéé æœŸé ­åƒ:', newSrc);
                                authorAvatarImg.src = randomUserImg;
                            }
                        }
                    });
                });

                observer.observe(authorAvatarImg, {
                    attributes: true,
                    attributeFilter: ['src']
                });
            }
        });
    </script>
    <script>
        // å¢å¼·ç‰ˆç•™è¨€ç³»çµ± - æ”¯æ´åœ–ç‰‡ä¸Šå‚³
        class EnhancedReplySystem {
            constructor() {
                this.replyToFloor = null;
                this.replyToContent = null;
                this.allReplies = [];
                this.selectedImages = [];
                this.maxImages = 5;
                this.articleId = null;
                this.commentsInitialized = false;
                this.isSubmitting = false;
                this.isEditSubmitting = false;

                // åˆ†é ç›¸é—œå±¬æ€§
                this.currentPage = 1;
                this.pageSize = 10;
                this.totalPages = 1;

                // ç¶å®šæ–¹æ³•ä»¥ä¿æŒ this ä¸Šä¸‹æ–‡
                this.handleImageSelect = this.handleImageSelect.bind(this);
                this.handleDragOver = this.handleDragOver.bind(this);
                this.handleDrop = this.handleDrop.bind(this);
                this.handlePaste = this.handlePaste.bind(this);
            }

            // è¨­ç½®å›è¦† (å·²ç¦ç”¨)
            setReplyTo(floor, content) {
                // å›è¦†åŠŸèƒ½å·²æš«æ™‚ç¦ç”¨
                console.log('ğŸ“ å›è¦†åŠŸèƒ½æš«æ™‚ç¦ç”¨');
                return;
            }

            // æ¸…é™¤å›è¦† (å·²ç¦ç”¨)
            clearReplyTo() {
                // å›è¦†åŠŸèƒ½å·²æš«æ™‚ç¦ç”¨
                console.log('ğŸ“ å›è¦†åŠŸèƒ½æš«æ™‚ç¦ç”¨');
                return;
            }

            // åœ–ç‰‡è™•ç†åŠŸèƒ½
            async convertFileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // æ·»åŠ åœ–ç‰‡åˆ°é è¦½
            async addImageToPreview(file) {
                if (this.selectedImages.length >= this.maxImages) {
                    this.showMessage(`æœ€å¤šåªèƒ½ä¸Šå‚³ ${this.maxImages} å¼µåœ–ç‰‡`, 'warning');
                    return;
                }

                // æª¢æŸ¥æª”æ¡ˆå¤§å° (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    this.showMessage('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 10MB', 'error');
                    return;
                }

                // æª¢æŸ¥æª”æ¡ˆé¡å‹
                if (!file.type.startsWith('image/')) {
                    this.showMessage('åªèƒ½ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ', 'error');
                    return;
                }

                try {
                    const base64 = await this.convertFileToBase64(file);
                    const imageData = {
                        file: file,
                        base64: base64,
                        id: Date.now() + Math.random()
                    };

                    this.selectedImages.push(imageData);
                    this.updateImagePreview();
                } catch (error) {
                    console.error('åœ–ç‰‡è™•ç†å¤±æ•—:', error);
                    this.showMessage('åœ–ç‰‡è™•ç†å¤±æ•—', 'error');
                }
            }

            // æ›´æ–°åœ–ç‰‡é è¦½
            updateImagePreview() {
                const container = document.getElementById('image-preview-container');
                const list = document.getElementById('image-preview-list');
                const count = document.getElementById('image-count');

                if (this.selectedImages.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';
                count.textContent = this.selectedImages.length;

                list.innerHTML = this.selectedImages.map((img, index) => `
                    <div class="image-preview-item">
                        <img src="${img.base64}" alt="é è¦½åœ–ç‰‡ ${index + 1}">
                        <button type="button" class="remove-image" onclick="window.replySystem.removeImage(${index})" title="ç§»é™¤åœ–ç‰‡">Ã—</button>
                    </div>
                `).join('');
            }

            // ç§»é™¤å–®å¼µåœ–ç‰‡
            removeImage(index) {
                this.selectedImages.splice(index, 1);
                this.updateImagePreview();

                // æ›´æ–°å‹•æ…‹ä¸Šå‚³å€åŸŸå…§å®¹
                const dynamicUploadArea = document.getElementById('dynamic-image-upload-area');
                if (dynamicUploadArea && dynamicUploadArea.style.display !== 'none') {
                    this.updateDynamicUploadAreaContent(dynamicUploadArea);
                }
            }

            // æ¸…é™¤æ‰€æœ‰åœ–ç‰‡
            clearAllImages() {
                this.selectedImages = [];
                this.updateImagePreview();

                // æ›´æ–°å‹•æ…‹ä¸Šå‚³å€åŸŸå…§å®¹
                const dynamicUploadArea = document.getElementById('dynamic-image-upload-area');
                if (dynamicUploadArea && dynamicUploadArea.style.display !== 'none') {
                    this.updateDynamicUploadAreaContent(dynamicUploadArea);
                }
            }

            // è™•ç†æª”æ¡ˆé¸æ“‡
            handleImageSelect(event) {
                const files = Array.from(event.target.files);
                files.forEach(file => this.addImageToPreview(file));
                event.target.value = ''; // æ¸…é™¤é¸æ“‡ï¼Œå…è¨±é‡è¤‡é¸æ“‡åŒä¸€æª”æ¡ˆ
            }

            // è™•ç†æ‹–æ‹½
            handleDragOver(event) {
                event.preventDefault();
                event.stopPropagation();
                const form = document.querySelector('.comment-form');
                form.classList.add('drag-over');
            }

            handleDragLeave(event) {
                event.preventDefault();
                event.stopPropagation();
                const form = document.querySelector('.comment-form');
                form.classList.remove('drag-over');
            }

            handleDrop(event) {
                event.preventDefault();
                event.stopPropagation();
                const form = document.querySelector('.comment-form');
                form.classList.remove('drag-over');

                const files = Array.from(event.dataTransfer.files);
                const imageFiles = files.filter(file => file.type.startsWith('image/'));

                if (imageFiles.length === 0) {
                    this.showMessage('è«‹æ‹–æ‹½åœ–ç‰‡æª”æ¡ˆ', 'warning');
                    return;
                }

                imageFiles.forEach(file => this.addImageToPreview(file));
            }

            // è™•ç†ç²˜è²¼
            handlePaste(event) {
                const clipboardData = event.clipboardData;
                if (!clipboardData) return;

                const items = Array.from(clipboardData.items);
                const imageItems = items.filter(item => item.type.startsWith('image/'));

                if (imageItems.length === 0) return;

                event.preventDefault(); // é˜»æ­¢é è¨­ç²˜è²¼è¡Œç‚º

                imageItems.forEach(item => {
                    const file = item.getAsFile();
                    if (file) {
                        this.addImageToPreview(file);
                    }
                });
            }

            // æ¸²æŸ“ç•™è¨€åˆ—è¡¨ï¼ˆå¢å¼·ç‰ˆï¼Œæ”¯æ´åœ–ç‰‡å’Œåˆ†é ï¼‰
            async renderRepliesSorted(sortType = 'newest') {
                console.log('ğŸ¨ é–‹å§‹æ¸²æŸ“ç•™è¨€ï¼Œæ•¸é‡:', this.allReplies ? this.allReplies.length : 0);
                console.log('ğŸ¨ ç•™è¨€æ•¸æ“š:', this.allReplies);

                if (!this.allReplies || this.allReplies.length === 0) {
                    console.log('ğŸ“ ç„¡ç•™è¨€æ•¸æ“šï¼Œé¡¯ç¤ºç©ºç‹€æ…‹');
                    const commentsList = document.querySelector('.comments-list');
                    if (commentsList) {
                        commentsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš«ç„¡ç•™è¨€ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç•™è¨€çš„äººå§ï¼</div>';
                    }
                    this.updatePagination(0);
                    return;
                }

                // å…ˆä¾æ™‚é–“éå¢æ’åºï¼Œå–å¾—æ­£ç¢ºæ¨“å±¤é †åº
                const timeSorted = this.allReplies.slice().sort((a, b) => new Date(a.replyTime) - new Date(b.replyTime));

                const floorMap = new Map();
                timeSorted.forEach((reply, idx) => {
                    const key = reply.replyId || reply.id || (reply.replyTime + '_' + (reply.memId || reply.mem_id || ''));
                    floorMap.set(key, idx + 1);
                });

                let sorted;
                if (sortType === 'oldest') {
                    sorted = timeSorted;
                } else {
                    sorted = timeSorted.slice().reverse();
                }

                // è¨ˆç®—åˆ†é 
                this.totalPages = Math.ceil(sorted.length / this.pageSize);
                console.log('ğŸ“„ ç¸½é æ•¸:', this.totalPages, 'ç•¶å‰é :', this.currentPage);

                // ç¢ºä¿ç•¶å‰é é¢åœ¨æœ‰æ•ˆç¯„åœå…§
                if (this.currentPage > this.totalPages) {
                    this.currentPage = Math.max(1, this.totalPages);
                }

                // è¨ˆç®—ç•¶å‰é é¢è¦é¡¯ç¤ºçš„ç•™è¨€ç¯„åœ
                const startIndex = (this.currentPage - 1) * this.pageSize;
                const endIndex = startIndex + this.pageSize;
                const currentPageReplies = sorted.slice(startIndex, endIndex);

                console.log('ğŸ“„ ç•¶å‰é ç•™è¨€:', startIndex, '-', endIndex, 'å…±', currentPageReplies.length, 'å‰‡');

                const commentsList = document.querySelector('.comments-list');
                if (!commentsList) return;

                // æ¸²æŸ“ç•¶å‰é é¢çš„ç•™è¨€HTMLï¼ˆåŒ…å«åœ–ç‰‡ï¼‰
                const commentsHTML = await Promise.all(currentPageReplies.map(async (reply, idx) => {
                    const replyKey = reply.replyId || reply.id || (reply.replyTime + '_' + (reply.memId || reply.mem_id || ''));
                    const floorNum = floorMap.get(replyKey) || 1;
                    const authorName = reply.memName || reply.mem_name || 'éœ²ç‡Ÿæ„›å¥½è€…';
                    const replyDate = reply.replyTime ? new Date(reply.replyTime).toLocaleString() : '';

                    // å›è¦†å¼•ç”¨
                    let replyQuoteHtml = '';
                    if (reply.replyToFloor && reply.replyToContent) {
                        replyQuoteHtml = `<div class="reply-quote" style="color:#555;background:#f2f2f2;padding:8px 12px;margin-bottom:8px;border-left:4px solid #bbb;font-size:0.97em;">å›è¦† #${reply.replyToFloor}: ${reply.replyToContent}</div>`;
                    }

                    // ç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ•ï¼ˆåƒ…æœ¬äººå¯è¦‹ï¼‰
                    let actionBtnsHtml = '';
                    let currentMemId = null;

                    console.log('ğŸ” æª¢æŸ¥ç•™è¨€æ¬Šé™ - ç•™è¨€ID:', reply.replyId || reply.id);
                    console.log('ğŸ” ç•™è¨€ä½œè€…ID:', reply.memId, 'æˆ–', reply.mem_id);

                    try {
                        const memberData = localStorage.getItem('currentMember') || sessionStorage.getItem('currentMember');
                        console.log('ğŸ” ç•¶å‰æœƒå“¡è³‡æ–™å­˜åœ¨:', !!memberData);

                        if (memberData) {
                            const member = JSON.parse(memberData);
                            currentMemId = member.mem_id || member.memId;
                            console.log('ğŸ” ç•¶å‰ç™»å…¥æœƒå“¡ID:', currentMemId);
                            console.log('ğŸ” æœƒå“¡è³‡æ–™è©³ç´°:', member);
                        }
                    } catch (e) {
                        console.error('ğŸ” è§£ææœƒå“¡è³‡æ–™å¤±æ•—:', e);
                        currentMemId = null;
                    }

                    const isOwner = currentMemId && (reply.memId == currentMemId || reply.mem_id == currentMemId);
                    console.log('ğŸ” æ˜¯å¦ç‚ºç•™è¨€ä½œè€…:', isOwner);
                    console.log('ğŸ” æ¯”è¼ƒçµæœ:', {
                        currentMemId: currentMemId,
                        replyMemId: reply.memId,
                        replyMem_id: reply.mem_id,
                        match1: reply.memId == currentMemId,
                        match2: reply.mem_id == currentMemId
                    });

                    if (isOwner) {
                        console.log('âœ… é¡¯ç¤ºç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ•');
                        actionBtnsHtml = `
                        <div class="comment-owner-actions" style="position:absolute;top:8px;right:12px;display:flex;gap:5px;z-index:2;">
                            <button class="edit-reply-btn" data-replyid="${reply.replyId || reply.id}" style="background:#28a745;color:#fff;border:none;border-radius:3px;padding:2px 8px;cursor:pointer;font-size:0.85em;">ç·¨è¼¯</button>
                            <button class="delete-reply-btn" data-replyid="${reply.replyId || reply.id}" style="background:#dc3545;color:#fff;border:none;border-radius:3px;padding:2px 8px;cursor:pointer;font-size:0.85em;">åˆªé™¤</button>
                        </div>
                    `;
                    } else {
                        console.log('âŒ ä¸é¡¯ç¤ºç·¨è¼¯æŒ‰éˆ• - éæœ¬äººç•™è¨€');
                    }

                    // ç²å–ç•™è¨€åœ–ç‰‡
                    let imagesHtml = '';
                    console.log('ğŸ–¼ï¸ æª¢æŸ¥ç•™è¨€åœ–ç‰‡ - ç•™è¨€ID:', reply.replyId);

                    if (reply.replyId) {
                        try {
                            const imageApiUrl = `${window.api_prefix}/api/reply-images/reply/${reply.replyId}`;
                            console.log('ğŸ–¼ï¸ è«‹æ±‚åœ–ç‰‡API:', imageApiUrl);

                            const imagesResponse = await fetch(imageApiUrl);
                            console.log('ğŸ–¼ï¸ åœ–ç‰‡APIå›æ‡‰ç‹€æ…‹:', imagesResponse.status);

                            if (imagesResponse.ok) {
                                const imagesResult = await imagesResponse.json();
                                console.log('ğŸ–¼ï¸ åœ–ç‰‡APIå›æ‡‰å…§å®¹:', imagesResult);

                                if (imagesResult.status === 'success' && imagesResult.data && imagesResult.data.length > 0) {
                                    console.log('ğŸ–¼ï¸ æ‰¾åˆ°åœ–ç‰‡æ•¸é‡:', imagesResult.data.length);
                                    const imageElements = imagesResult.data.map((img, imgIndex) => {
                                        const imgUrl = `${window.api_prefix}/api/reply-images/${img.replyImgId}/image`;
                                        console.log('ğŸ–¼ï¸ åœ–ç‰‡URL:', imgUrl);
                                        return `<img src="${imgUrl}" 
                                                     class="comment-image" 
                                                     data-image-loaded="false"
                                                     onclick="window.replySystem.showImageLightbox('${imgUrl}')" 
                                                     alt="ç•™è¨€åœ–ç‰‡"
                                                     onload="
                                                         console.log('âœ… ç•™è¨€åœ–ç‰‡è¼‰å…¥æˆåŠŸ:', '${imgUrl}');
                                                         this.setAttribute('data-image-loaded', 'true');
                                                     "
                                                     onerror="
                                                         if (this.getAttribute('data-image-loaded') === 'false') {
                                                             console.log('ğŸ–¼ï¸ ç•™è¨€åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤åœ–æ¨™:', '${imgUrl}');
                                                             this.style.display = 'none';
                                                             this.setAttribute('data-image-loaded', 'true');
                                                             if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('image-error-placeholder')) {
                                                                 const placeholder = document.createElement('div');
                                                                 placeholder.className = 'image-error-placeholder';
                                                                 placeholder.innerHTML = '<i class=\\'fas fa-image\\' style=\\'font-size: 24px; color: #dc3545; margin-bottom: 8px;\\'></i><br>åœ–ç‰‡ç„¡æ³•è¼‰å…¥';
                                                                 placeholder.style.cssText = 'display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; color: #6c757d; font-size: 14px; padding: 20px; min-height: 80px; cursor: not-allowed; text-align: center;';
                                                                 this.parentNode.insertBefore(placeholder, this.nextSibling);
                                                             }
                                                             this.onerror = null;
                                                         }
                                                     " />`;
                                    }).join('');
                                    imagesHtml = `<div class="comment-images">${imageElements}</div>`;
                                    console.log('ğŸ–¼ï¸ åœ–ç‰‡HTML:', imagesHtml);
                                } else {
                                    console.log('ğŸ–¼ï¸ æ²’æœ‰åœ–ç‰‡æˆ–APIè¿”å›å¤±æ•—');
                                }
                            } else {
                                console.log('ğŸ–¼ï¸ åœ–ç‰‡APIè«‹æ±‚å¤±æ•—:', imagesResponse.status);
                            }
                        } catch (error) {
                            console.error('ğŸ–¼ï¸ è¼‰å…¥ç•™è¨€åœ–ç‰‡å¤±æ•—:', error);
                        }
                    } else {
                        console.log('ğŸ–¼ï¸ ç•™è¨€æ²’æœ‰replyIdï¼Œè·³éåœ–ç‰‡æª¢æŸ¥');
                    }

                    return `
                        <div class="comment-item" style="position:relative;" data-replyid="${reply.replyId || reply.id}">
                        ${actionBtnsHtml}
                            <div class="comment-header">
                                <div class="comment-avatar">
                                    ${this.createAvatarElement(reply, idx)}
                                </div>
                                <div class="comment-author">
                                    <div class="comment-author-name">${authorName}</div>
                                    <div class="comment-date">${replyDate}</div>
                                </div>
                                <div class="comment-floor">#${floorNum}</div>
                            </div>
                                                        <div class="comment-content" data-replyid="${reply.replyId || reply.id}">
                            ${replyQuoteHtml}
                                                        <div class="comment-text" data-original-text="${(reply.replyContext || '').replace(/" /g, '&quot;')}">${reply.replyContext ? reply.replyContext.replace(/\n/g, '<br>') : 'ç„¡å…§å®¹'}</div>

                                ${imagesHtml}
                        </div>
                            <div class="comment-actions" style="display: none;">
                                <!-- å›è¦†åŠŸèƒ½æš«æ™‚éš±è— -->
                        <a href="#" class="comment-action reply-btn" data-floor="${floorNum}" data-content="${(reply.replyContext || '').replace(/" /g, '&quot;')}" style="display: none;">
                                    <i class="fas fa-reply"></i>
                                    <span>å›è¦†</span>
                                </a>
                            </div>
                        </div>
                    `;
                }));

                commentsList.innerHTML = commentsHTML.join('');

                // æ›´æ–°åˆ†é å°èˆª
                this.updatePagination(sorted.length);

                // æ›´æ–°ç•™è¨€æ¨™é¡Œé¡¯ç¤º
                this.updateCommentsTitle(sorted.length);

                // ç¶å®šäº‹ä»¶
                this.bindReplyEvents();
            }

            // æ›´æ–°åˆ†é å°èˆª
            updatePagination(totalReplies) {
                const pagination = document.querySelector('.pagination');
                if (!pagination) return;

                if (totalReplies === 0 || this.totalPages <= 1) {
                    // æ²’æœ‰ç•™è¨€æˆ–åªæœ‰ä¸€é æ™‚éš±è—åˆ†é 
                    pagination.style.display = 'none';
                    return;
                }

                pagination.style.display = 'flex';

                let paginationHTML = '';

                // ä¸Šä¸€é æŒ‰éˆ•
                if (this.currentPage > 1) {
                    paginationHTML += `< a href = "#" class="page-btn prev-btn" data - page="${this.currentPage - 1}" > ä¸Šä¸€é </a > `;
                }

                // é ç¢¼æŒ‰éˆ•
                const maxShowPages = 5; // æœ€å¤šé¡¯ç¤º5å€‹é ç¢¼
                let startPage = Math.max(1, this.currentPage - Math.floor(maxShowPages / 2));
                let endPage = Math.min(this.totalPages, startPage + maxShowPages - 1);

                // èª¿æ•´èµ·å§‹é é¢ï¼Œç¢ºä¿é¡¯ç¤ºè¶³å¤ çš„é ç¢¼
                if (endPage - startPage + 1 < maxShowPages) {
                    startPage = Math.max(1, endPage - maxShowPages + 1);
                }

                // å¦‚æœèµ·å§‹é é¢å¤§æ–¼1ï¼Œé¡¯ç¤ºç¬¬ä¸€é å’Œçœç•¥è™Ÿ
                if (startPage > 1) {
                    paginationHTML += `< a href = "#" class="page-btn" data - page="1" > 1</a > `;
                    if (startPage > 2) {
                        paginationHTML += `< span class="page-ellipsis" >...</span > `;
                    }
                }

                // é¡¯ç¤ºé ç¢¼
                for (let i = startPage; i <= endPage; i++) {
                    const activeClass = i === this.currentPage ? ' active' : '';
                    paginationHTML += `< a href = "#" class="page-btn${activeClass}" data - page="${i}" > ${i}</a > `;
                }

                // å¦‚æœçµæŸé é¢å°æ–¼ç¸½é æ•¸ï¼Œé¡¯ç¤ºçœç•¥è™Ÿå’Œæœ€å¾Œä¸€é 
                if (endPage < this.totalPages) {
                    if (endPage < this.totalPages - 1) {
                        paginationHTML += `< span class="page-ellipsis" >...</span > `;
                    }
                    paginationHTML += `< a href = "#" class="page-btn" data - page="${this.totalPages}" > ${this.totalPages}</a > `;
                }

                // ä¸‹ä¸€é æŒ‰éˆ•
                if (this.currentPage < this.totalPages) {
                    paginationHTML += `< a href = "#" class="page-btn next-btn" data - page="${this.currentPage + 1}" > ä¸‹ä¸€é </a > `;
                }

                pagination.innerHTML = paginationHTML;

                // ç¶å®šåˆ†é æŒ‰éˆ•é»æ“Šäº‹ä»¶
                this.bindPaginationEvents();

                console.log('ğŸ“„ åˆ†é å°èˆªå·²æ›´æ–°:', this.currentPage, '/', this.totalPages);
            }

            // ç¶å®šåˆ†é æŒ‰éˆ•äº‹ä»¶
            bindPaginationEvents() {
                const pageButtons = document.querySelectorAll('.page-btn');
                pageButtons.forEach(btn => {
                    btn.onclick = (e) => {
                        e.preventDefault();
                        const page = parseInt(btn.getAttribute('data-page'));
                        if (page && page !== this.currentPage) {
                            this.goToPage(page);
                        }
                    };
                });
            }

            // è·³è½‰åˆ°æŒ‡å®šé é¢
            async goToPage(page) {
                if (page < 1 || page > this.totalPages || page === this.currentPage) {
                    return;
                }

                console.log('ğŸ“„ è·³è½‰åˆ°ç¬¬', page, 'é ');
                this.currentPage = page;

                // é‡æ–°æ¸²æŸ“ç•¶å‰æ’åºçš„ç•™è¨€
                const sortSelect = document.querySelector('.sort-comments');
                const sortType = sortSelect ? sortSelect.value : 'newest';
                await this.renderRepliesSorted(sortType);

                // æ»¾å‹•åˆ°ç•™è¨€å€åŸŸé ‚éƒ¨
                const commentsSection = document.querySelector('.comments-section');
                if (commentsSection) {
                    commentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            // æ›´æ–°ç•™è¨€æ¨™é¡Œé¡¯ç¤º
            updateCommentsTitle(totalReplies) {
                const commentsTitle = document.querySelector('.comments-title');
                if (!commentsTitle) return;

                if (totalReplies <= this.pageSize) {
                    // åªæœ‰ä¸€é æˆ–æ²’æœ‰ç•™è¨€
                    commentsTitle.textContent = `ç•™è¨€è¨è«–(${totalReplies})`;
                } else {
                    // å¤šé é¡¯ç¤ºè©³ç´°ä¿¡æ¯
                    const startNum = (this.currentPage - 1) * this.pageSize + 1;
                    const endNum = Math.min(this.currentPage * this.pageSize, totalReplies);
                    commentsTitle.textContent = `ç•™è¨€è¨è«–(ç¬¬ ${this.currentPage} é ï¼Œ${startNum} - ${endNum} / å…± ${totalReplies} å‰‡)`;
                }
            }

            // è™•ç†åˆªé™¤ç•™è¨€å¾Œçš„åˆ†é èª¿æ•´
            async handleAfterDelete() {
                console.log('ğŸ—‘ï¸ è™•ç†åˆªé™¤å¾Œçš„åˆ†é èª¿æ•´...');

                // é‡æ–°è¼‰å…¥ç•™è¨€æ•¸æ“š
                await this.loadReplies();

                // è¨ˆç®—æ–°çš„ç¸½é æ•¸
                if (this.allReplies && this.allReplies.length > 0) {
                    const newTotalPages = Math.ceil(this.allReplies.length / this.pageSize);

                    // å¦‚æœç•¶å‰é é¢è¶…éäº†æ–°çš„ç¸½é æ•¸ï¼Œèª¿æ•´åˆ°æœ€å¾Œä¸€é 
                    if (this.currentPage > newTotalPages) {
                        console.log('ğŸ“„ ç•¶å‰é é¢è¶…å‡ºç¯„åœï¼Œèª¿æ•´åˆ°ç¬¬', newTotalPages, 'é ');
                        this.currentPage = Math.max(1, newTotalPages);
                    }

                    // æª¢æŸ¥ç•¶å‰é é¢æ˜¯å¦é‚„æœ‰ç•™è¨€
                    const startIndex = (this.currentPage - 1) * this.pageSize;
                    const endIndex = startIndex + this.pageSize;
                    const currentPageReplies = this.allReplies.slice(startIndex, endIndex);

                    // å¦‚æœç•¶å‰é é¢æ²’æœ‰ç•™è¨€ï¼Œä½†ç¸½å…±é‚„æœ‰ç•™è¨€ï¼Œèª¿æ•´åˆ°ä¸Šä¸€é 
                    if (currentPageReplies.length === 0 && this.allReplies.length > 0) {
                        this.currentPage = Math.max(1, this.currentPage - 1);
                        console.log('ğŸ“„ ç•¶å‰é é¢ç„¡ç•™è¨€ï¼Œèª¿æ•´åˆ°ç¬¬', this.currentPage, 'é ');
                    }
                } else {
                    // æ²’æœ‰ç•™è¨€äº†ï¼Œå›åˆ°ç¬¬ä¸€é 
                    this.currentPage = 1;
                    console.log('ğŸ“„ ç„¡ç•™è¨€ï¼Œå›åˆ°ç¬¬ä¸€é ');
                }

                // é‡æ–°æ¸²æŸ“
                const sortSelect = document.querySelector('.sort-comments');
                const sortType = sortSelect ? sortSelect.value : 'newest';
                await this.renderRepliesSorted(sortType);
            }

            // ç¶å®šå›è¦†ã€ç·¨è¼¯å’Œåˆªé™¤äº‹ä»¶
            bindReplyEvents() {
                // å›è¦†æŒ‰éˆ• (å·²ç¦ç”¨)
                const replyBtns = document.querySelectorAll('.reply-btn');
                replyBtns.forEach(btn => {
                    btn.onclick = (e) => {
                        e.preventDefault();
                        console.log('ğŸ“ å›è¦†åŠŸèƒ½æš«æ™‚ç¦ç”¨');
                        // å›è¦†åŠŸèƒ½å·²æš«æ™‚ç¦ç”¨
                        return;
                    };
                });

                // ç·¨è¼¯æŒ‰éˆ•
                const editBtns = document.querySelectorAll('.edit-reply-btn');
                editBtns.forEach(btn => {
                    btn.onclick = (e) => {
                        e.preventDefault();
                        const replyId = btn.getAttribute('data-replyid');
                        this.startEditReply(replyId);
                    };
                });

                // åˆªé™¤æŒ‰éˆ•
                const delBtns = document.querySelectorAll('.delete-reply-btn');
                delBtns.forEach(btn => {
                    btn.onclick = async (e) => {
                        e.preventDefault();
                        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç•™è¨€å—ï¼Ÿ')) return;

                        const replyId = btn.getAttribute('data-replyid');
                        try {
                            const response = await fetch(`${window.api_prefix}/api/replies/${replyId}`, {
                                method: 'DELETE'
                            });

                            if (response.ok) {
                                this.showMessage('ç•™è¨€å·²åˆªé™¤', 'success');
                                // åˆªé™¤ç•™è¨€å¾Œå¯èƒ½éœ€è¦èª¿æ•´ç•¶å‰é é¢
                                await this.handleAfterDelete();
                            } else {
                                this.showMessage('åˆªé™¤å¤±æ•—', 'error');
                            }
                        } catch (error) {
                            console.error('åˆªé™¤ç•™è¨€å¤±æ•—:', error);
                            this.showMessage('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                        }
                    };
                });
            }

            // é¡¯ç¤ºåœ–ç‰‡ç‡ˆç®±
            showImageLightbox(imageSrc) {
                // ç§»é™¤ç¾æœ‰ç‡ˆç®±
                const existingLightbox = document.querySelector('.image-lightbox');
                if (existingLightbox) {
                    existingLightbox.remove();
                }

                // å‰µå»ºæ–°ç‡ˆç®±
                const lightbox = document.createElement('div');
                lightbox.className = 'image-lightbox';
                lightbox.innerHTML = `
            <img src = "${imageSrc}" alt = "æ”¾å¤§åœ–ç‰‡" >
                    <button class="close-lightbox">Ã—</button>
                `;

                // é»æ“Šé—œé–‰
                lightbox.onclick = (e) => {
                    if (e.target === lightbox || e.target.className === 'close-lightbox') {
                        lightbox.remove();
                    }
                };

                // ESC éµé—œé–‰
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        lightbox.remove();
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);

                document.body.appendChild(lightbox);
            }

            // é–‹å§‹ç·¨è¼¯ç•™è¨€
            async startEditReply(replyId) {
                console.log('ğŸ–Šï¸ é–‹å§‹ç·¨è¼¯ç•™è¨€:', replyId);

                // ç¢ºä¿ç•™è¨€è³‡æ–™å·²è¼‰å…¥
                if (!this.allReplies || this.allReplies.length === 0) {
                    console.log('ğŸ”„ ç•™è¨€è³‡æ–™æœªè¼‰å…¥ï¼Œé‡æ–°è¼‰å…¥...');
                    await this.loadReplies();
                }

                // æ‰¾åˆ°ç•™è¨€é …ç›®
                const commentItem = document.querySelector(`.comment-item[data-replyid="${replyId}"]`);
                if (!commentItem) {
                    console.error('æ‰¾ä¸åˆ°ç•™è¨€é …ç›®');
                    return;
                }

                // æ‰¾åˆ°ç•™è¨€æ–‡å­—å…ƒç´ 
                const commentText = commentItem.querySelector('.comment-text');
                if (!commentText) {
                    console.error('æ‰¾ä¸åˆ°ç•™è¨€æ–‡å­—å…ƒç´ ');
                    return;
                }

                // ç²å–åŸå§‹æ–‡å­—
                const originalText = commentText.getAttribute('data-original-text') || commentText.textContent;
                console.log('ğŸ“ åŸå§‹æ–‡å­—:', originalText);

                // å‰µå»ºç·¨è¼¯è¡¨å–®
                const editForm = document.createElement('div');
                editForm.className = 'edit-reply-form';
                editForm.style.cssText = `
                    margin: 10px 0;
                    padding: 15px;
                    background: #f8f9fa;
        border - radius: 6px;
                    border: 1px solid #e9ecef;
                `;

                editForm.innerHTML = `
            <div style = "margin-bottom: 10px; font-size: 0.9rem; color: #666;" >
                        <i class="fas fa-edit"></i> ç·¨è¼¯ç•™è¨€
                    </div >
                    <textarea class="edit-textarea" style="
                        width: 100%;
                        min-height: 80px;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        font-family: inherit;
                        font-size: 0.95rem;
                        resize: vertical;
                        box-sizing: border-box;
                        margin-bottom: 10px;
                    ">${originalText}</textarea>
                    
                    <!--åœ–ç‰‡ç·¨è¼¯å€åŸŸ -->
                    <div class="edit-images-section" style="margin-bottom: 10px;">
                        <div style="margin-bottom: 8px; font-size: 0.9rem; color: #666;">
                            <i class="fas fa-images"></i> åœ–ç‰‡ (æœ€å¤š5å¼µï¼Œæ¯å¼µæœ€å¤§10MB)
                        </div>
                        
                        <!-- ç•¶å‰åœ–ç‰‡é¡¯ç¤ºå€ -->
                        <div class="current-images" style="margin-bottom: 10px;">
                            <div class="current-images-grid" style="
                                display: grid;
                                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                                gap: 8px;
                                margin-bottom: 10px;
                            "></div>
                            <div class="current-images-note" style="font-size: 0.8rem; color: #666;">
                                ç•¶å‰åœ–ç‰‡ï¼ˆé»æ“Š âŒ ç§»é™¤ï¼Œå„²å­˜æ™‚å°‡ä¿ç•™æœªç§»é™¤çš„åœ–ç‰‡ä¸¦æ–°å¢é¸æ“‡çš„åœ–ç‰‡ï¼‰
                            </div>
                        </div>
                        
                        <!-- æ–°åœ–ç‰‡ä¸Šå‚³å€ -->
                        <div class="new-images-upload" style="
                            border: 2px dashed #ddd;
                            border-radius: 4px;
                            padding: 20px;
                            text-align: center;
                            background: white;
                            cursor: pointer;
                            transition: border-color 0.3s;
                        " onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='#ddd'">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 1.5rem; color: #007bff; margin-bottom: 10px;"></i>
                            <div style="margin-bottom: 5px; color: #333;">é»æ“Šæˆ–æ‹–æ‹½ä¸Šå‚³æ–°åœ–ç‰‡ï¼ˆå¯å¤šé¸ï¼‰</div>
                            <div style="font-size: 0.8rem; color: #666;">æ”¯æ´ JPGã€PNGã€GIF æ ¼å¼ï¼Œå¯å¤šæ¬¡é¸æ“‡ç´¯ç©è‡³5å¼µ</div>
                            <input type="file" class="edit-image-input" multiple accept="image/*" style="display: none;">
                        </div>
                        
                        <!-- æ–°åœ–ç‰‡é è¦½å€ -->
                        <div class="new-images-preview" style="
                            margin-top: 10px;
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                            gap: 8px;
                        "></div>
                    </div>
                    
                    <div class="edit-actions" style="
                        display: flex;
                        gap: 10px;
                        justify-content: flex-end;
                    ">
                        <button type="button" class="cancel-edit-btn" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 6px 15px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        ">å–æ¶ˆ</button>
                        <button type="button" class="save-edit-btn" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 6px 15px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        ">å„²å­˜</button>
                    </div>
                `;

                // éš±è—åŸå§‹æ–‡å­—
                commentText.style.display = 'none';

                // æ’å…¥ç·¨è¼¯è¡¨å–®
                commentText.parentNode.insertBefore(editForm, commentText.nextSibling);

                // éš±è—æ“ä½œæŒ‰éˆ•
                const actionBtns = commentItem.querySelector('.comment-owner-actions');
                if (actionBtns) {
                    actionBtns.style.display = 'none';
                }

                // è¼‰å…¥ç•¶å‰åœ–ç‰‡
                await this.loadCurrentReplyImages(replyId, editForm);

                // ç¶å®šç·¨è¼¯è¡¨å–®äº‹ä»¶
                const textarea = editForm.querySelector('.edit-textarea');
                const saveBtn = editForm.querySelector('.save-edit-btn');
                const cancelBtn = editForm.querySelector('.cancel-edit-btn');
                const imageInput = editForm.querySelector('.edit-image-input');
                const uploadArea = editForm.querySelector('.new-images-upload');

                // è‡ªå‹•èšç„¦åˆ°æ–‡å­—æ¡†æœ«å°¾
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);

                // åˆå§‹åŒ–åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½
                this.initEditImageUpload(editForm, replyId);

                // ä¿å­˜æŒ‰éˆ•
                saveBtn.onclick = () => {
                    const newContent = textarea.value.trim();
                    const newImages = this.getEditSelectedImages(editForm);

                    // æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
                    if (newContent === originalText && newImages.length === 0) {
                        this.cancelEditReply(replyId);
                        return;
                    }

                    this.saveEditReply(replyId, newContent, newImages);
                };

                // å–æ¶ˆæŒ‰éˆ•
                cancelBtn.onclick = () => {
                    this.cancelEditReply(replyId);
                };

                // Enter + Ctrl å¿«æ·éµå„²å­˜
                textarea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        const newContent = textarea.value.trim();
                        const newImages = this.getEditSelectedImages(editForm);

                        if (newContent !== originalText || newImages.length > 0) {
                            this.saveEditReply(replyId, newContent, newImages);
                        }
                    }
                    // ESC å–æ¶ˆ
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        this.cancelEditReply(replyId);
                    }
                });

                console.log('âœ… ç·¨è¼¯è¡¨å–®å·²å»ºç«‹');
            }

            // è¼‰å…¥ç•¶å‰ç•™è¨€çš„åœ–ç‰‡
            async loadCurrentReplyImages(replyId, editForm) {
                console.log('ğŸ–¼ï¸ è¼‰å…¥ç•¶å‰ç•™è¨€åœ–ç‰‡:', replyId);

                try {
                    const response = await fetch(`${window.api_prefix}/api/reply-images/reply/${replyId}`);
                    const result = await response.json();

                    const currentImagesGrid = editForm.querySelector('.current-images-grid');

                    if (response.ok && result.status === 'success' && result.data.length > 0) {
                        console.log('ğŸ“¸ æ‰¾åˆ°åœ–ç‰‡:', result.data.length, 'å¼µ');
                        currentImagesGrid.innerHTML = result.data.map(image => `
                            <div class="current-image-item" style="position: relative; border-radius: 4px; overflow: hidden; aspect-ratio: 1;">
                                <img src="${window.api_prefix}/api/reply-images/${image.replyImgId}/image"
                                    alt="ç•¶å‰åœ–ç‰‡"
                                    style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;"
                                    onclick="window.replySystem.showImageLightbox('${window.api_prefix}/api/reply-images/${image.replyImgId}/image')"
                                    onerror="
                                        console.log('ğŸ–¼ï¸ ç·¨è¼¯é é¢åœ–ç‰‡è¼‰å…¥å¤±æ•—:', '${window.api_prefix}/api/reply-images/${image.replyImgId}/image');
                                        this.style.display = 'none';
                                        if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('edit-image-error-placeholder')) {
                                            const placeholder = document.createElement('div');
                                            placeholder.className = 'edit-image-error-placeholder';
                                            placeholder.innerHTML = 'ğŸ–¼ï¸<br>åœ–ç‰‡ç„¡æ³•é¡¯ç¤º';
                                            placeholder.style.cssText = 'display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; color: #6c757d; font-size: 12px; text-align: center; width: 100%; height: 100%; cursor: not-allowed; position: absolute; top: 0; left: 0;';
                                            this.parentNode.appendChild(placeholder);
                                        }
                                        this.onerror = null;">
                                <div class="remove-current-image"
                                    style="position: absolute; top: 2px; right: 2px; background: rgba(220, 53, 69, 0.8); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                                    onclick="this.parentElement.remove()" title="ç§»é™¤æ­¤åœ–ç‰‡">âŒ</div>
                            </div>
                        `).join('');
                    } else {
                        console.log('ğŸ“· æ­¤ç•™è¨€æ²’æœ‰åœ–ç‰‡');
                        currentImagesGrid.innerHTML = '<div style="text-align: center; color: #666; font-size: 0.9rem; padding: 20px;">æ­¤ç•™è¨€æ²’æœ‰åœ–ç‰‡</div>';
                    }
                } catch (error) {
                    console.error('âŒ è¼‰å…¥ç•¶å‰åœ–ç‰‡å¤±æ•—:', error);
                    const currentImagesGrid = editForm.querySelector('.current-images-grid');
                    currentImagesGrid.innerHTML = '<div style="text-align: center; color: #dc3545; font-size: 0.9rem; padding: 20px;">è¼‰å…¥åœ–ç‰‡å¤±æ•—</div>';
                }
            }

            // åˆå§‹åŒ–ç·¨è¼¯æ™‚çš„åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½
            initEditImageUpload(editForm, replyId) {
                const imageInput = editForm.querySelector('.edit-image-input');
                const uploadArea = editForm.querySelector('.new-images-upload');
                const previewArea = editForm.querySelector('.new-images-preview');

                // é»æ“Šä¸Šå‚³å€åŸŸè§¸ç™¼æª”æ¡ˆé¸æ“‡
                uploadArea.onclick = () => imageInput.click();

                // æª”æ¡ˆé¸æ“‡äº‹ä»¶
                imageInput.addEventListener('change', (e) => {
                    this.handleEditImageSelection(e.target.files, previewArea);
                    // æ¸…ç©ºè¼¸å…¥æ¡†çš„å€¼ï¼Œå…è¨±é‡è¤‡é¸æ“‡ç›¸åŒæª”æ¡ˆæˆ–å¤šæ¬¡é¸æ“‡
                    e.target.value = '';
                });

                // æ‹–æ‹½ä¸Šå‚³
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#007bff';
                    uploadArea.style.backgroundColor = '#f8f9ff';
                });

                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#ddd';
                    uploadArea.style.backgroundColor = 'white';
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#ddd';
                    uploadArea.style.backgroundColor = 'white';

                    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                    this.handleEditImageSelection(files, previewArea);
                });
            }

            // è™•ç†ç·¨è¼¯æ™‚çš„åœ–ç‰‡é¸æ“‡
            handleEditImageSelection(files, previewArea) {
                console.log('ğŸ–¼ï¸ ç·¨è¼¯æ™‚é¸æ“‡åœ–ç‰‡:', files.length);

                if (files.length === 0) return;

                // æª¢æŸ¥ç•¶å‰å·²æœ‰çš„åœ–ç‰‡æ•¸é‡
                const currentCount = previewArea.querySelectorAll('.edit-image-preview-item').length;
                const totalCount = currentCount + files.length;

                if (totalCount > 5) {
                    this.showMessage(`æœ€å¤šåªèƒ½é¸æ“‡5å¼µåœ–ç‰‡ï¼Œæ‚¨å·²æœ‰${currentCount} å¼µï¼Œå†é¸æ“‡${files.length} å¼µæœƒè¶…éé™åˆ¶`, 'warning');
                    return;
                }

                // ä¸æ¸…ç©ºä¹‹å‰çš„é è¦½ï¼Œå…è¨±ç´¯ç©é¸æ“‡

                Array.from(files).forEach((file, index) => {
                    // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆ10MBï¼‰
                    if (file.size > 10 * 1024 * 1024) {
                        this.showMessage(`åœ–ç‰‡ ${file.name} è¶…é10MBé™åˆ¶`, 'warning');
                        return;
                    }

                    // å‰µå»ºé è¦½
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'edit-image-preview-item';
                        previewItem.style.cssText = `
                            position: relative;
        border - radius: 4px;
                            overflow: hidden;
        aspect - ratio: 1;
                            width: 100%;
        max-width: 100px;
                            border: 2px solid #28a745;
                        `;

                        previewItem.innerHTML = `
    <img src="${e.target.result}"
        alt="æ–°åœ–ç‰‡é è¦½"
        style="width:100%;height:100%;object-fit:cover;">
            < div class="remove-preview-image"
        style = "
                                     position: absolute;
                                     top: 2px;
                                     right: 2px;
                                     background: rgba(220, 53, 69, 0.8);
                                     color: white;
                                     border: none;
        border - radius: 50 %;
                                     width: 20px;
                                     height: 20px;
        font - size: 12px;
                                     cursor: pointer;
                                     display: flex;
        align - items: center;
        justify - content: center;
                                 "
        onclick = "this.parentElement.remove(); console.log('ğŸ—‘ï¸ ç§»é™¤ç·¨è¼¯åœ–ç‰‡ï¼Œå‰©é¤˜:', document.querySelectorAll('.edit-image-preview-item').length - 1, 'å¼µ');"
        title = "ç§»é™¤æ­¤åœ–ç‰‡" >
                                âŒ
                            </div >
                            <div style="
                                position: absolute;
                                bottom: 2px;
                                left: 2px;
                                background: rgba(40, 167, 69, 0.8);
                                color: white;
                                padding: 2px 6px;
                                border-radius: 2px;
                                font-size: 0.7rem;
                            ">æ–°</div>
                        `;

                        // å„²å­˜æª”æ¡ˆåˆ°é è¦½é …ç›®
                        previewItem._file = file;
                        previewArea.appendChild(previewItem);
                    };

                    reader.readAsDataURL(file);
                });
            }

            // ç²å–ç·¨è¼¯æ™‚é¸æ“‡çš„åœ–ç‰‡
            getEditSelectedImages(editForm) {
                const previewArea = editForm.querySelector('.new-images-preview');
                const previewItems = previewArea.querySelectorAll('.edit-image-preview-item');

                const selectedImages = [];
                previewItems.forEach(item => {
                    if (item._file) {
                        selectedImages.push(item._file);
                    }
                });

                console.log('ğŸ“¸ ç·¨è¼¯æ™‚é¸æ“‡çš„åœ–ç‰‡æ•¸é‡:', selectedImages.length);
                return selectedImages;
            }

            // å„²å­˜ç·¨è¼¯çš„ç•™è¨€
            async saveEditReply(replyId, newContent, images = []) {
                if (!newContent && images.length === 0) {
                    this.showMessage('ç•™è¨€å…§å®¹ä¸èƒ½ç‚ºç©º', 'warning');
                    return;
                }

                console.log('ğŸ’¾ å„²å­˜ç·¨è¼¯çš„ç•™è¨€:', replyId, newContent);
                console.log('ğŸ–¼ï¸ ç·¨è¼¯çš„åœ–ç‰‡æ•¸é‡:', images.length);

                // é˜²æ­¢é‡è¤‡æäº¤
                if (this.isEditSubmitting) {
                    console.log('âš ï¸ æ­£åœ¨ç·¨è¼¯æäº¤ä¸­ï¼Œå¿½ç•¥é‡è¤‡è«‹æ±‚');
                    return;
                }
                this.isEditSubmitting = true;

                try {
                    // ç¦ç”¨å„²å­˜æŒ‰éˆ•
                    const commentItem = document.querySelector(`.comment-item[data-replyid="${replyId}"]`);
                    const saveBtn = commentItem.querySelector('.save-edit-btn');
                    const cancelBtn = commentItem.querySelector('.cancel-edit-btn');

                    if (saveBtn) {
                        saveBtn.textContent = 'å„²å­˜ä¸­...';
                        saveBtn.disabled = true;
                    }
                    if (cancelBtn) {
                        cancelBtn.disabled = true;
                    }

                    // ç²å–åŸå§‹ç•™è¨€è³‡æ–™
                    const originalReply = this.allReplies.find(reply => {
                        const currentReplyId = reply.replyId || reply.id;
                        return currentReplyId == replyId;
                    });
                    if (!originalReply) {
                        console.log('ğŸ” ç•¶å‰ allReplies:', this.allReplies);
                        console.log('ğŸ” å°‹æ‰¾çš„ replyId:', replyId);
                        throw new Error('æ‰¾ä¸åˆ°åŸå§‹ç•™è¨€è³‡æ–™');
                    }

                    // æ§‹å»ºå®Œæ•´çš„è«‹æ±‚è³‡æ–™
                    const requestData = {
                        replyContext: newContent,
                        memId: originalReply.memId || originalReply.mem_id,
                        acId: originalReply.acId || originalReply.ac_id,
                        replyTime: originalReply.replyTime || originalReply.reply_time,
                        replyStatus: originalReply.replyStatus || originalReply.reply_status || 0
                    };

                    console.log('ğŸ“¤ ç™¼é€ç·¨è¼¯è«‹æ±‚:', requestData);

                    // èª¿ç”¨æ›´æ–°API
                    const response = await fetch(`${window.api_prefix}/api/replies/${replyId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    console.log('ğŸ“¡ ç·¨è¼¯APIå›æ‡‰ç‹€æ…‹:', response.status);
                    const result = await response.json();
                    console.log('ğŸ“¥ ç·¨è¼¯APIå›æ‡‰å…§å®¹:', result);

                    if (response.ok && result.status === 'success') {
                        // å¦‚æœæœ‰æ–°åœ–ç‰‡éœ€è¦è™•ç†
                        if (images.length > 0) {
                            console.log('ğŸ–¼ï¸ é–‹å§‹è™•ç†ç·¨è¼¯çš„åœ–ç‰‡...');

                            // å…ˆåˆªé™¤èˆŠåœ–ç‰‡
                            try {
                                await fetch(`${window.api_prefix}/api/reply-images/reply/${replyId}/cleanup`, {
                                    method: 'DELETE'
                                });
                                console.log('ğŸ—‘ï¸ èˆŠåœ–ç‰‡å·²æ¸…ç†');
                            } catch (error) {
                                console.warn('âš ï¸ æ¸…ç†èˆŠåœ–ç‰‡å¤±æ•—:', error);
                            }

                            // ä¸Šå‚³æ–°åœ–ç‰‡
                            for (let i = 0; i < Math.min(images.length, 5); i++) {
                                try {
                                    const formData = new FormData();
                                    formData.append('replyImg', images[i]);
                                    formData.append('replyId', replyId);

                                    const uploadResponse = await fetch(`${window.api_prefix}/api/reply-images/upload`, {
                                        method: 'POST',
                                        body: formData
                                    });

                                    if (!uploadResponse.ok) {
                                        console.warn(`âš ï¸ åœ–ç‰‡ ${i + 1} ä¸Šå‚³å¤±æ•—`);
                                    } else {
                                        console.log(`âœ… åœ–ç‰‡ ${i + 1} ä¸Šå‚³æˆåŠŸ`);
                                    }
                                } catch (error) {
                                    console.warn(`âš ï¸ åœ–ç‰‡ ${i + 1} ä¸Šå‚³ç•°å¸¸:`, error);
                                }
                            }
                        }

                        this.showMessage('ç•™è¨€å·²æ›´æ–°', 'success');

                        // ç§»é™¤ç·¨è¼¯è¡¨å–®
                        this.cancelEditReply(replyId);

                        // é‡æ–°è¼‰å…¥ç•™è¨€ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„å…§å®¹
                        await this.loadReplies();

                    } else {
                        this.showMessage('æ›´æ–°å¤±æ•—: ' + (result.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');

                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                        if (saveBtn) {
                            saveBtn.textContent = 'å„²å­˜';
                            saveBtn.disabled = false;
                        }
                        if (cancelBtn) {
                            cancelBtn.disabled = false;
                        }
                    }
                } catch (error) {
                    console.error('ğŸ’¥ å„²å­˜ç·¨è¼¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    this.showMessage('å„²å­˜å¤±æ•—: ' + error.message, 'error');

                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    const commentItem = document.querySelector(`.comment-item[data-replyid="${replyId}"]`);
                    const saveBtn = commentItem.querySelector('.save-edit-btn');
                    const cancelBtn = commentItem.querySelector('.cancel-edit-btn');

                    if (saveBtn) {
                        saveBtn.textContent = 'å„²å­˜';
                        saveBtn.disabled = false;
                    }
                    if (cancelBtn) {
                        cancelBtn.disabled = false;
                    }
                } finally {
                    this.isEditSubmitting = false;
                }
            }

            // å–æ¶ˆç·¨è¼¯ç•™è¨€
            cancelEditReply(replyId) {
                console.log('âŒ å–æ¶ˆç·¨è¼¯ç•™è¨€:', replyId);

                const commentItem = document.querySelector(`.comment-item[data-replyid="${replyId}"]`);
                if (!commentItem) return;

                // ç§»é™¤ç·¨è¼¯è¡¨å–®
                const editForm = commentItem.querySelector('.edit-reply-form');
                if (editForm) {
                    editForm.remove();
                }

                // é¡¯ç¤ºåŸå§‹æ–‡å­—
                const commentText = commentItem.querySelector('.comment-text');
                if (commentText) {
                    commentText.style.display = '';
                }

                // é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
                const actionBtns = commentItem.querySelector('.comment-owner-actions');
                if (actionBtns) {
                    actionBtns.style.display = '';
                }

                console.log('âœ… ç·¨è¼¯å·²å–æ¶ˆ');
            }

            // ç”Ÿæˆæœƒå“¡é ­åƒURL
            generateAvatarUrl(reply) {
                // æª¢æŸ¥ç•™è¨€æ•¸æ“šä¸­æ˜¯å¦æœ‰é ­åƒæ¬„ä½
                const memId = reply.memId || reply.mem_id;

                // å¤šç¨®å¯èƒ½çš„é ­åƒæ¬„ä½åç¨±
                const avatarFields = [
                    reply.memImg, reply.mem_img,
                    reply.profileImg, reply.profile_img,
                    reply.avatar, reply.userAvatar, reply.user_avatar,
                    reply.memPic, reply.mem_pic
                ];

                // æª¢æŸ¥æ˜¯å¦æœ‰ç›´æ¥çš„é ­åƒURLï¼ˆä½†æ’é™¤å¯èƒ½æŒ‡å‘user-åœ–ç‰‡çš„æ¬„ä½ï¼‰
                for (const avatarField of avatarFields) {
                    if (avatarField && typeof avatarField === 'string') {
                        // æ’é™¤å¯èƒ½æŒ‡å‘user-åœ–ç‰‡çš„æ¬„ä½
                        if (avatarField.includes('user-') || avatarField.includes('default-avatar')) {
                            console.log('ğŸš« è·³éå¯èƒ½æŒ‡å‘user-åœ–ç‰‡çš„æ¬„ä½:', avatarField);
                            continue;
                        }

                        // å¦‚æœæ˜¯å®Œæ•´URLï¼Œç›´æ¥ä½¿ç”¨
                        if (avatarField.startsWith('http')) {
                            return avatarField;
                        }
                        // å¦‚æœæ˜¯ç›¸å°è·¯å¾‘ï¼Œçµ„åˆå®Œæ•´URL
                        if (avatarField.startsWith('/') || avatarField.includes('.')) {
                            return `${window.api_prefix}${avatarField.startsWith('/') ? '' : '/'}${avatarField}`;
                        }
                    }
                }

                // å¦‚æœæ²’æœ‰ç›´æ¥çš„é ­åƒURLï¼Œå˜—è©¦é€šéæœƒå“¡IDç²å–
                if (memId) {
                    // æ­£ç¢ºçš„æœƒå“¡é ­åƒAPIç«¯é»
                    return `${window.api_prefix}/member/${memId}/pic`;
                }

                // å¦‚æœéƒ½æ²’æœ‰ï¼Œè¿”å›nullï¼Œç¨å¾Œä½¿ç”¨é»˜èªé ­åƒ
                return null;
            }

            // å‰µå»ºé ­åƒHTMLå…ƒç´ ï¼ˆæ”¯æ´éŒ¯èª¤è™•ç†ï¼‰
            createAvatarElement(reply, index) {
                const memId = reply.memId || reply.mem_id;
                const avatarUrl = this.generateAvatarUrl(reply);
                const defaultAvatarUrl = `images/user-${((index % 4) + 1)}.jpg`;
                const fallbackAvatar = `images/user-${Math.floor(Math.random() * 4) + 1}.jpg`; // éš¨æ©Ÿå‚™ç”¨é ­åƒ

                if (avatarUrl) {
                    // å˜—è©¦ä½¿ç”¨çœŸå¯¦é ­åƒï¼Œå¤±æ•—æ™‚ç›´æ¥ä½¿ç”¨user-é–‹é ­çš„åœ–ç‰‡ï¼ˆé¿å…ç„¡é™é‡è©¦ï¼‰
                    return `
                        <img src="${avatarUrl}" 
                             alt="ç•™è¨€è€…é ­åƒ" 
                             data-avatar-loaded="false"
                             onload="
                                 console.log('âœ… ç•™è¨€è€…é ­åƒè¼‰å…¥æˆåŠŸ:', '${avatarUrl}');
                                 this.setAttribute('data-avatar-loaded', 'true');
                             "
                             onerror="
                                 if (this.getAttribute('data-avatar-loaded') === 'false') {
                                     console.log('âš ï¸ ç•™è¨€è€…é ­åƒè¼‰å…¥å¤±æ•—ï¼Œç›´æ¥ä½¿ç”¨user-é–‹é ­çš„åœ–ç‰‡:', '${avatarUrl}');
                                     this.src = '${defaultAvatarUrl}';
                                     this.setAttribute('data-avatar-loaded', 'true');
                                     this.onerror = null;
                                 }
                             " />
                    `;
                } else {
                    console.log('ğŸ“· æœƒå“¡', memId, 'æ²’æœ‰é ­åƒä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨user-é–‹é ­çš„åœ–ç‰‡');
                    // ç›´æ¥ä½¿ç”¨user-é–‹é ­çš„åœ–ç‰‡
                    return `
                        <img src="${defaultAvatarUrl}" 
                             alt="ç•™è¨€è€…é ­åƒ" 
                             data-avatar-loaded="true"
                             onerror="
                                 console.log('âš ï¸ user-é–‹é ­åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨éš¨æ©Ÿå‚™ç”¨é ­åƒ');
                                 this.src = '${fallbackAvatar}';
                                 this.onerror = null;
                             " />
                    `;
                }
            }

            // å˜—è©¦å¾ç•™è¨€è³‡æ–™æ›´æ–°ä½œè€…é ­åƒï¼ˆå·²ç¦ç”¨ï¼Œé¿å…éŒ¯èª¤æ¨æ–·ï¼‰
            tryUpdateAuthorAvatarFromReplies() {
                console.log('ğŸ” å˜—è©¦å¾ç•™è¨€è³‡æ–™æ›´æ–°ä½œè€…é ­åƒ...');
                console.log('âŒ å¾ç•™è¨€æ¨æ–·ä½œè€…é ­åƒåŠŸèƒ½å·²ç¦ç”¨ï¼Œé¿å…é¡¯ç¤ºéŒ¯èª¤çš„é ­åƒ');
                // ä¸å†å¾ç•™è¨€æ¨æ–·ä½œè€…IDï¼Œé˜²æ­¢é¡¯ç¤ºå…¶ä»–ç”¨æˆ¶çš„é ­åƒ
                return;
            }

            // æ›´æ–°æ–‡ç« ä½œè€…é ­åƒï¼ˆé˜²é–ƒçˆç‰ˆæœ¬ï¼‰
            updateArticleAuthorAvatar(authorData) {
                const authorAvatarImg = document.querySelector('.author-avatar img');
                if (!authorAvatarImg) {
                    console.log('[DEBUG] æ‰¾ä¸åˆ°é ­åƒå…ƒç´ ');
                    return;
                }

                // å¦‚æœå·²ç¶“æ›´æ–°éä¸”æ˜¯æ­£ç¢ºçš„é ­åƒï¼Œè·³éé‡è¤‡æ›´æ–°ï¼ˆé™¤éæ˜¯å¼·åˆ¶æ›´æ–°ï¼‰
                if (authorAvatarImg.dataset.avatarUpdated === 'true' && authorData !== null) {
                    console.log('[DEBUG] é ­åƒå·²æ›´æ–°éï¼Œè·³éé‡è¤‡æ›´æ–°');
                    return;
                }

                // é¡å¤–ä¿è­·ï¼šå¦‚æœé ­åƒå·²ç¶“æ˜¯æ­£ç¢ºçš„APIé ­åƒï¼Œé¿å…è¢«è¦†è“‹ï¼ˆé™¤éå¼·åˆ¶æ›´æ–°ï¼‰
                if (authorData && authorAvatarImg.src.includes('/member/') && !authorData.forceUpdate) {
                    console.log('[DEBUG] é ­åƒå·²æ˜¯æ­£ç¢ºçš„APIé ­åƒï¼Œè·³éè¦†è“‹');
                    authorAvatarImg.dataset.avatarUpdated = 'true';
                    return;
                }

                // å¦‚æœæ˜¯å¼·åˆ¶æ›´æ–°ï¼Œé‡ç½®æ›´æ–°æ¨™è¨˜
                if (authorData && authorData.forceUpdate) {
                    console.log('[DEBUG] å¼·åˆ¶æ›´æ–°é ­åƒï¼Œé‡ç½®æ›´æ–°æ¨™è¨˜');
                    authorAvatarImg.dataset.avatarUpdated = 'false';
                }

                // è™•ç†ç„¡ä½œè€…è³‡æ–™çš„æƒ…æ³ï¼ˆé¡¯ç¤ºé è¨­é ­åƒï¼‰
                if (!authorData) {
                    const randomUserImg = `images/user-${Math.floor(Math.random() * 4) + 1}.jpg`;
                    authorAvatarImg.style.display = 'none';
                    authorAvatarImg.src = randomUserImg;
                    authorAvatarImg.onerror = null;
                    authorAvatarImg.onload = function () {
                        this.style.display = '';
                        this.dataset.avatarUpdated = 'true';
                    };
                    console.log('[DEBUG] ç„¡ä½œè€…è³‡æ–™ï¼Œé¡¯ç¤ºé è¨­ user- åœ–ç‰‡:', randomUserImg);
                    return;
                }

                // åƒ…å…è¨±æ˜ç¢ºçš„ä½œè€…ID - æª¢æŸ¥å¤šç¨®å¯èƒ½çš„æ¬„ä½
                const authorId = authorData?.memId ||
                    authorData?.mem_id ||
                    authorData?.memberVO?.memId ||
                    authorData?.memberVO?.mem_id ||
                    authorData?.acMemId ||
                    authorData?.ac_mem_id ||
                    authorData?.authorId ||
                    authorData?.author_id;
                if (!authorId || (authorId !== 0 && !Number(authorId))) {
                    // æ²’æœ‰æ˜ç¢ºIDå°±é¡¯ç¤ºéš¨æ©Ÿ user- åœ–ç‰‡
                    const randomUserImg = `images/user-${Math.floor(Math.random() * 4) + 1}.jpg`;
                    authorAvatarImg.style.display = 'none';
                    authorAvatarImg.src = randomUserImg;
                    authorAvatarImg.onerror = null;
                    authorAvatarImg.onload = function () {
                        this.style.display = '';
                        this.dataset.avatarUpdated = 'true';
                    };
                    console.log('[DEBUG] æ²’æœ‰æ˜ç¢ºä½œè€…IDï¼Œé¡¯ç¤ºéš¨æ©Ÿ user- åœ–ç‰‡:', randomUserImg, '(authorId:', authorId, ')');
                    return;
                }

                // éš±è—é ­åƒæº–å‚™æ›´æ–°
                authorAvatarImg.style.display = 'none';

                // å˜—è©¦ API é ­åƒ
                const avatarUrl = `${window.api_prefix}/member/${authorId}/pic`;
                console.log('[DEBUG] è¨­å®šæ–‡ç« ä½œè€…é ­åƒ src =', avatarUrl, 'ï¼Œä½œè€…ID =', authorId);

                const tempImg = new Image();
                tempImg.onload = function () {
                    // API è¼‰å…¥æˆåŠŸ
                    authorAvatarImg.src = avatarUrl;
                    authorAvatarImg.onerror = null;
                    authorAvatarImg.onload = function () {
                        this.style.display = '';
                        this.dataset.avatarUpdated = 'true';
                        console.log('[DEBUG] æ–‡ç« ä½œè€…é ­åƒè¼‰å…¥æˆåŠŸï¼Œé¡¯ç¤º');
                    };
                };
                tempImg.onerror = function () {
                    // APIå¤±æ•—ï¼Œä½¿ç”¨ user- åœ–ç‰‡
                    const randomUserImg = `images/user-${Math.floor(Math.random() * 4) + 1}.jpg`;
                    authorAvatarImg.src = randomUserImg;
                    authorAvatarImg.onerror = null;
                    authorAvatarImg.onload = function () {
                        this.style.display = '';
                        this.dataset.avatarUpdated = 'true';
                    };
                    console.log('[DEBUG] APIå¤±æ•—ï¼Œæ”¹ç”¨ user- åœ–ç‰‡ src =', randomUserImg);
                };
                tempImg.src = avatarUrl;
            }

            // è¼‰å…¥ç•™è¨€
            async loadReplies() {
                if (!this.articleId) return;

                try {
                    const response = await fetch(`${window.api_prefix}/api/replies/article/${this.articleId}`);
                    const result = await response.json();

                    if (result.status === 'success' && Array.isArray(result.data)) {
                        this.allReplies = result.data;

                        // æ›´æ–°ç•™è¨€æ¨™é¡Œï¼ˆåˆå§‹è¼‰å…¥æ™‚ä¸é¡¯ç¤ºåˆ†é ä¿¡æ¯ï¼‰
                        const commentsTitle = document.querySelector('.comments-title');
                        if (commentsTitle) {
                            commentsTitle.textContent = `ç•™è¨€è¨è«– (${this.allReplies.length})`;
                        }

                        const sortSelect = document.querySelector('.sort-comments');
                        const sortType = sortSelect ? sortSelect.value : 'newest';
                        await this.renderRepliesSorted(sortType);

                        // ç•™è¨€è¼‰å…¥å®Œæˆ
                        console.log('ğŸ“ ç•™è¨€è¼‰å…¥å®Œæˆ');
                    } else {
                        console.error('è¼‰å…¥ç•™è¨€å¤±æ•—:', result);
                    }
                } catch (error) {
                    console.error('è¼‰å…¥ç•™è¨€æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    const commentsList = document.querySelector('.comments-list');
                    if (commentsList) {
                        commentsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">è¼‰å…¥ç•™è¨€å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
                    }
                }
            }

            // æäº¤ç•™è¨€
            async submitReply() {
                console.log('ğŸš€ é–‹å§‹æäº¤ç•™è¨€...');

                // é˜²æ­¢é‡è¤‡æäº¤
                if (this.isSubmitting) {
                    console.log('âš ï¸ æ­£åœ¨æäº¤ä¸­ï¼Œå¿½ç•¥é‡è¤‡è«‹æ±‚');
                    return;
                }

                const textarea = document.getElementById('reply-textarea');
                const replyContent = textarea.value.trim();

                console.log('ğŸ“ ç•™è¨€å…§å®¹:', replyContent);
                console.log('ğŸ–¼ï¸ é¸æ“‡çš„åœ–ç‰‡æ•¸é‡:', this.selectedImages.length);
                console.log('ğŸ“„ æ–‡ç« ID:', this.articleId);

                if (!replyContent && this.selectedImages.length === 0) {
                    this.showMessage('è«‹è¼¸å…¥ç•™è¨€å…§å®¹æˆ–ä¸Šå‚³åœ–ç‰‡', 'warning');
                    return;
                }

                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                const memberData = localStorage.getItem('currentMember') || sessionStorage.getItem('currentMember');
                console.log('ğŸ‘¤ æœƒå“¡è³‡æ–™:', memberData ? 'å·²æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');

                if (!memberData) {
                    this.showMessage('è«‹å…ˆç™»å…¥å¾Œå†ç™¼è¡¨ç•™è¨€', 'warning');
                    setTimeout(() => {
                        window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
                    }, 2000);
                    return;
                }

                const member = JSON.parse(memberData);
                const memId = member.mem_id || member.memId;
                console.log('ğŸ†” æœƒå“¡ID:', memId);
                console.log('ğŸ“Š æœƒå“¡å®Œæ•´è³‡æ–™:', member);

                if (!memId) {
                    this.showMessage('æœƒå“¡è³‡è¨ŠéŒ¯èª¤ï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
                    return;
                }

                // æª¢æŸ¥æ–‡ç« IDï¼Œä¸¦å˜—è©¦é‡æ–°ç²å–
                if (!this.articleId) {
                    console.log('ğŸ” æ–‡ç« IDä¸å­˜åœ¨ï¼Œå˜—è©¦é‡æ–°ç²å–...');

                    // å˜—è©¦å¾URLç²å–ï¼Œæ”¯æ´ acId å’Œ id åƒæ•¸
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlId = urlParams.get('acId') || urlParams.get('id');
                    if (urlId) {
                        this.articleId = parseInt(urlId);
                        console.log('âœ… å¾URLé‡æ–°ç²å–åˆ°æ–‡ç« ID:', this.articleId);
                    } else if (window.currentArticle && window.currentArticle.acId) {
                        this.articleId = window.currentArticle.acId;
                        console.log('âœ… å¾currentArticleé‡æ–°ç²å–åˆ°æ–‡ç« ID:', this.articleId);
                    } else if (window.articleDisplayManager && window.articleDisplayManager.getCurrentArticleId) {
                        this.articleId = window.articleDisplayManager.getCurrentArticleId();
                        console.log('âœ… å¾articleDisplayManageré‡æ–°ç²å–åˆ°æ–‡ç« ID:', this.articleId);
                    }
                }

                if (!this.articleId) {
                    console.error('âŒ æ‰€æœ‰æ–¹æ³•éƒ½ç„¡æ³•ç²å–æ–‡ç« ID');
                    this.showMessage('ç„¡æ³•å–å¾—æ–‡ç« è³‡è¨Šï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
                    return;
                }

                console.log('âœ… ç¢ºèªæ–‡ç« ID:', this.articleId);

                // è¨­ç½®æäº¤ä¸­æ¨™èªŒ
                this.isSubmitting = true;

                try {
                    const submitBtn = document.getElementById('submit-reply-btn');
                    submitBtn.textContent = 'ç™¼å¸ƒä¸­...';
                    submitBtn.disabled = true;

                    let result;
                    let apiUrl;
                    let replyData;

                    if (this.selectedImages.length > 0) {
                        // æœ‰åœ–ç‰‡çš„ç•™è¨€
                        apiUrl = `${window.api_prefix}/api/replies/with-images`;
                        replyData = {
                            memId: parseInt(memId),
                            acId: parseInt(this.articleId),
                            replyContext: replyContent || '',
                            images: this.selectedImages.map(img => img.base64)
                        };

                        // æ·»åŠ å›è¦†è³‡è¨Š
                        if (this.replyToFloor && this.replyToContent) {
                            replyData.replyToFloor = this.replyToFloor;
                            replyData.replyToContent = this.replyToContent;
                        }

                        console.log('ğŸ“¸ æº–å‚™ç™¼é€å¸¶åœ–ç‰‡çš„ç•™è¨€');
                        console.log('ğŸ”— APIç«¯é»:', apiUrl);
                        console.log('ğŸ“¤ ç™¼é€è³‡æ–™:', {
                            ...replyData,
                            images: `${replyData.images.length} å¼µåœ–ç‰‡ (å·²çœç•¥base64å…§å®¹)`
                        });

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(replyData)
                        });

                        console.log('ğŸ“¡ APIå›æ‡‰ç‹€æ…‹:', response.status);
                        result = await response.json();
                        console.log('ğŸ“¥ APIå›æ‡‰å…§å®¹:', result);

                    } else {
                        // ç´”æ–‡å­—ç•™è¨€
                        apiUrl = `${window.api_prefix}/api/replies`;
                        replyData = {
                            memId: parseInt(memId),
                            acId: parseInt(this.articleId),
                            replyContext: replyContent
                        };

                        // æ·»åŠ å›è¦†è³‡è¨Š
                        if (this.replyToFloor && this.replyToContent) {
                            replyData.replyToFloor = this.replyToFloor;
                            replyData.replyToContent = this.replyToContent;
                        }

                        console.log('ğŸ’¬ æº–å‚™ç™¼é€ç´”æ–‡å­—ç•™è¨€');
                        console.log('ğŸ”— APIç«¯é»:', apiUrl);
                        console.log('ğŸ“¤ ç™¼é€è³‡æ–™:', replyData);

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(replyData)
                        });

                        console.log('ğŸ“¡ APIå›æ‡‰ç‹€æ…‹:', response.status);

                        // æª¢æŸ¥å›æ‡‰æ˜¯å¦ç‚ºæœ‰æ•ˆçš„JSON
                        const responseText = await response.text();
                        console.log('ğŸ“„ åŸå§‹å›æ‡‰å…§å®¹:', responseText);

                        try {
                            result = JSON.parse(responseText);
                            console.log('ğŸ“¥ è§£æå¾Œçš„APIå›æ‡‰:', result);
                        } catch (parseError) {
                            console.error('âŒ JSONè§£æå¤±æ•—:', parseError);
                            console.error('ğŸ“„ ç„¡æ³•è§£æçš„å›æ‡‰å…§å®¹:', responseText);
                            this.showMessage('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤', 'error');
                            return;
                        }
                    }

                    if (result && result.status === 'success') {
                        console.log('âœ… ç•™è¨€æäº¤æˆåŠŸ');
                        this.showMessage('ç•™è¨€ç™¼å¸ƒæˆåŠŸï¼', 'success');

                        // æ¸…é™¤è¡¨å–®
                        textarea.value = '';
                        this.clearAllImages();
                        this.clearReplyTo();

                        // é‡æ–°è¼‰å…¥ç•™è¨€ï¼ˆå›åˆ°ç¬¬ä¸€é é¡¯ç¤ºæ–°ç•™è¨€ï¼‰
                        console.log('ğŸ”„ é‡æ–°è¼‰å…¥ç•™è¨€åˆ—è¡¨...');
                        this.currentPage = 1; // æ–°ç•™è¨€ç™¼å¸ƒå¾Œå›åˆ°ç¬¬ä¸€é 
                        await this.loadReplies();
                    } else {
                        console.error('âŒ ç•™è¨€æäº¤å¤±æ•—:', result);
                        this.showMessage('ç•™è¨€ç™¼å¸ƒå¤±æ•—: ' + (result && result.message ? result.message : 'æœªçŸ¥éŒ¯èª¤'), 'error');
                    }

                } catch (error) {
                    console.error('ğŸ’¥ æäº¤ç•™è¨€æ™‚ç™¼ç”Ÿä¾‹å¤–:', error);
                    console.error('ğŸ” éŒ¯èª¤å †ç–Š:', error.stack);
                    this.showMessage('ç•™è¨€æäº¤å¤±æ•—: ' + error.message, 'error');
                } finally {
                    // é‡ç½®æäº¤æ¨™èªŒ
                    this.isSubmitting = false;

                    const submitBtn = document.getElementById('submit-reply-btn');
                    if (submitBtn) {
                        submitBtn.textContent = 'ç™¼å¸ƒç•™è¨€';
                        submitBtn.disabled = false;
                    }
                    console.log('ğŸ ç•™è¨€æäº¤æµç¨‹çµæŸ');
                }
            }

            // é¡¯ç¤ºè¨Šæ¯
            showMessage(message, type) {
                // ç§»é™¤ç¾æœ‰è¨Šæ¯
                const existingMessage = document.querySelector('.floating-message');
                if (existingMessage) {
                    existingMessage.remove();
                }

                // å‰µå»ºè¨Šæ¯å…ƒç´ 
                const messageDiv = document.createElement('div');
                messageDiv.className = 'floating-message';
                messageDiv.textContent = message;
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 6px;
                    color: white;
                    font-weight: 500;
                    z-index: 1001;
                    animation: slideInRight 0.3s ease;
                    max-width: 300px;
                    word-wrap: break-word;
                `;

                // æ ¹æ“šé¡å‹è¨­ç½®èƒŒæ™¯è‰²
                switch (type) {
                    case 'success':
                        messageDiv.style.backgroundColor = '#28a745';
                        break;
                    case 'error':
                        messageDiv.style.backgroundColor = '#dc3545';
                        break;
                    case 'warning':
                        messageDiv.style.backgroundColor = '#ffc107';
                        messageDiv.style.color = '#212529';
                        break;
                    default:
                        messageDiv.style.backgroundColor = '#6c757d';
                }

                // æ·»åŠ å‹•ç•«æ¨£å¼
                if (!document.querySelector('#floating-message-style')) {
                    const style = document.createElement('style');
                    style.id = 'floating-message-style';
                    style.textContent = `
                        @keyframes slideInRight {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                        @keyframes slideOutRight {
                            from { transform: translateX(0); opacity: 1; }
                            to { transform: translateX(100%); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }

                document.body.appendChild(messageDiv);

                // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
                setTimeout(() => {
                    messageDiv.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 300);
                }, 3000);
            }

            // åˆå§‹åŒ–ç³»çµ±
            init() {
                console.log('ğŸ¬ é–‹å§‹åˆå§‹åŒ–ç•™è¨€ç³»çµ±...');

                if (this.commentsInitialized) {
                    console.log('âš ï¸ ç•™è¨€ç³»çµ±å·²ç¶“åˆå§‹åŒ–éï¼Œè·³é');
                    return;
                }
                this.commentsInitialized = true;
                console.log('âœ… è¨­ç½®åˆå§‹åŒ–æ¨™è¨˜ç‚º true');

                // å¤šç¨®æ–¹å¼ç²å–æ–‡ç« ID
                console.log('â³ é–‹å§‹ç²å–æ–‡ç« ID...');

                const getArticleIdFromMultipleSources = () => {
                    // æ–¹æ³•1: å¾ articleDisplayManager ç²å–
                    if (window.articleDisplayManager && window.articleDisplayManager.getCurrentArticleId) {
                        const id1 = window.articleDisplayManager.getCurrentArticleId();
                        if (id1) {
                            console.log('ğŸ“„ å¾ articleDisplayManager ç²å–åˆ°ID:', id1);
                            return id1;
                        }
                    }

                    // æ–¹æ³•2: å¾ URL åƒæ•¸ç²å–ï¼Œæ”¯æ´ acId å’Œ id åƒæ•¸
                    const urlParams = new URLSearchParams(window.location.search);
                    const id2 = urlParams.get('acId') || urlParams.get('id');
                    if (id2) {
                        console.log('ğŸ“„ å¾ URL åƒæ•¸ç²å–åˆ°ID:', id2);
                        return parseInt(id2);
                    }

                    // æ–¹æ³•3: å¾å…¨åŸŸè®Šæ•¸ç²å–ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (window.currentArticleId) {
                        console.log('ğŸ“„ å¾å…¨åŸŸè®Šæ•¸ç²å–åˆ°ID:', window.currentArticleId);
                        return window.currentArticleId;
                    }

                    // æ–¹æ³•4: å¾ articles.js çš„å…¨åŸŸè®Šæ•¸ç²å–
                    if (window.currentArticle && window.currentArticle.acId) {
                        console.log('ğŸ“„ å¾ currentArticle å…¨åŸŸè®Šæ•¸ç²å–åˆ°ID:', window.currentArticle.acId);
                        return window.currentArticle.acId;
                    }

                    console.log('âŒ ç„¡æ³•å¾ä»»ä½•ä¾†æºç²å–æ–‡ç« ID');
                    return null;
                };

                // å˜—è©¦ç«‹å³ç²å–æ–‡ç« ID
                let articleId = getArticleIdFromMultipleSources();

                if (articleId) {
                    console.log('âœ… ç«‹å³ç²å–åˆ°æ–‡ç« ID:', articleId);
                    this.articleId = articleId;
                    this.initializeUI();
                    this.loadReplies();
                } else {
                    // å¦‚æœç«‹å³ç„¡æ³•ç²å–ï¼Œå‰‡ç­‰å¾…
                    console.log('â³ ç«‹å³ç„¡æ³•ç²å–æ–‡ç« IDï¼Œé–‹å§‹ç­‰å¾…...');
                    let attemptCount = 0;
                    const maxAttempts = 50; // æœ€å¤šç­‰å¾…5ç§’

                    const checkArticleId = setInterval(() => {
                        attemptCount++;
                        console.log(`ğŸ” ç¬¬ ${attemptCount} æ¬¡å˜—è©¦ç²å–æ–‡ç« ID...`);

                        articleId = getArticleIdFromMultipleSources();

                        if (articleId) {
                            this.articleId = articleId;
                            console.log('âœ… ç­‰å¾…å¾Œç²å–åˆ°æ–‡ç« ID:', this.articleId);
                            clearInterval(checkArticleId);

                            console.log('ğŸ”§ é–‹å§‹åˆå§‹åŒ–UI...');
                            this.initializeUI();

                            console.log('ğŸ“ é–‹å§‹è¼‰å…¥ç•™è¨€...');
                            this.loadReplies();
                        } else if (attemptCount >= maxAttempts) {
                            console.error('âŒ è¶…éæœ€å¤§å˜—è©¦æ¬¡æ•¸ï¼Œä»ç„¡æ³•ç²å–æ–‡ç« ID');
                            clearInterval(checkArticleId);

                            // æœ€å¾Œå˜—è©¦ï¼šç›´æ¥åˆå§‹åŒ–UIï¼Œä¸ç®¡æ–‡ç« ID
                            console.log('ğŸ†˜ å¼·åˆ¶åˆå§‹åŒ–UIï¼ˆç„¡æ–‡ç« IDï¼‰...');
                            this.initializeUI();
                        }
                    }, 100);
                }

                // ç›£è½æ–‡ç« è¼‰å…¥å®Œæˆäº‹ä»¶ï¼Œæ›´æ–°ä½œè€…é ­åƒ
                this.setupArticleAuthorAvatarWatcher();

                console.log('ğŸ¬ ç•™è¨€ç³»çµ±åˆå§‹åŒ–è¨­ç½®å®Œæˆ');
            }

            // è¨­ç½®æ–‡ç« ä½œè€…é ­åƒç›£è½å™¨
            setupArticleAuthorAvatarWatcher() {
                console.log('ğŸ‘€ è¨­ç½®æ–‡ç« ä½œè€…é ­åƒç›£è½å™¨...');

                // æ–¹æ³•1: ç›£è½å…¨åŸŸæ–‡ç« è®Šæ•¸è®ŠåŒ–
                const checkArticleData = () => {
                    if (window.currentArticle) {
                        const authorId = window.currentArticle.memId ||
                            window.currentArticle.mem_id ||
                            window.currentArticle.memberVO?.memId ||
                            window.currentArticle.memberVO?.mem_id ||
                            window.currentArticle.acMemId ||
                            window.currentArticle.ac_mem_id;

                        if (authorId) {
                            console.log('ğŸ“„ æª¢æ¸¬åˆ°æ–‡ç« è³‡æ–™è¼‰å…¥å®Œæˆï¼Œæ›´æ–°ä½œè€…é ­åƒ');
                            this.updateArticleAuthorAvatar(window.currentArticle);
                            return true;
                        }
                    }
                    return false;
                };

                // æ–¹æ³•2: ç›£è½ ArticleDisplayManager çš„æ–‡ç« è¼‰å…¥
                const checkArticleDisplayManager = () => {
                    if (window.articleDisplayManager && window.articleDisplayManager.currentArticle) {
                        const authorId = window.articleDisplayManager.currentArticle.memId ||
                            window.articleDisplayManager.currentArticle.mem_id ||
                            window.articleDisplayManager.currentArticle.memberVO?.memId ||
                            window.articleDisplayManager.currentArticle.memberVO?.mem_id ||
                            window.articleDisplayManager.currentArticle.acMemId ||
                            window.articleDisplayManager.currentArticle.ac_mem_id;

                        if (authorId) {
                            console.log('ğŸ“„ å¾ ArticleDisplayManager ç²å–æ–‡ç« è³‡æ–™ï¼Œæ›´æ–°ä½œè€…é ­åƒ');
                            this.updateArticleAuthorAvatar(window.articleDisplayManager.currentArticle);
                            return true;
                        }
                    }
                    return false;
                };

                // é˜²æ­¢é‡è¤‡æ›´æ–°çš„æ¨™è¨˜
                let avatarUpdated = false;

                // æ–¹æ³•3: ç›£è½DOMè®ŠåŒ–ï¼Œæª¢æ¸¬ä½œè€…å§“åè¼‰å…¥å®Œæˆ
                const checkAuthorNameLoaded = () => {
                    if (avatarUpdated) return true; // å·²ç¶“æ›´æ–°éï¼Œè·³é

                    const authorNameElement = document.querySelector('.author-name');
                    if (authorNameElement && authorNameElement.textContent !== 'è¼‰å…¥ä¸­...') {
                        console.log('ğŸ“„ æª¢æ¸¬åˆ°ä½œè€…å§“åè¼‰å…¥å®Œæˆ:', authorNameElement.textContent);

                        // å˜—è©¦å¾å¤šå€‹ä¾†æºç²å–ä½œè€…è³‡æ–™
                        let authorData = null;
                        let authorId = null;

                        // ä¾†æº1: window.currentArticle
                        if (window.currentArticle) {
                            console.log('ğŸ” æª¢æŸ¥ window.currentArticle çµæ§‹:', window.currentArticle);
                            console.log('ğŸ” å¯ç”¨æ¬„ä½:', Object.keys(window.currentArticle));

                            // æª¢æŸ¥å¤šç¨®å¯èƒ½çš„ä½œè€…IDæ¬„ä½
                            authorId = window.currentArticle.memId ||
                                window.currentArticle.mem_id ||
                                window.currentArticle.memberVO?.memId ||
                                window.currentArticle.memberVO?.mem_id ||
                                window.currentArticle.acMemId ||
                                window.currentArticle.ac_mem_id ||
                                window.currentArticle.authorId ||
                                window.currentArticle.author_id;

                            if (authorId) {
                                authorData = window.currentArticle;
                                console.log('âœ… å¾ window.currentArticle ç²å–åˆ°ä½œè€…ID:', authorId, '(ä¾†æºæ¬„ä½:', Object.keys(window.currentArticle).filter(k => k.toLowerCase().includes('mem') || k.toLowerCase().includes('author')), ')');
                            } else {
                                console.log('âŒ window.currentArticle ä¸­æ‰¾ä¸åˆ°ä½œè€…IDï¼Œå¯ç”¨æ¬„ä½:', Object.keys(window.currentArticle));
                                console.log('âŒ è©³ç´°æ¬„ä½å€¼æª¢æŸ¥:');
                                console.log('  memId:', window.currentArticle.memId);
                                console.log('  mem_id:', window.currentArticle.mem_id);
                                console.log('  acMemId:', window.currentArticle.acMemId);
                                console.log('  ac_mem_id:', window.currentArticle.ac_mem_id);
                                console.log('  memberVO:', window.currentArticle.memberVO);
                                console.log('  authorId:', window.currentArticle.authorId);
                                console.log('  author_id:', window.currentArticle.author_id);
                            }
                        }

                        // ä¾†æº2: articleDisplayManager
                        if (!authorData && window.articleDisplayManager && window.articleDisplayManager.currentArticle) {
                            console.log('ğŸ” æª¢æŸ¥ articleDisplayManager.currentArticle çµæ§‹:', window.articleDisplayManager.currentArticle);
                            console.log('ğŸ” å¯ç”¨æ¬„ä½:', Object.keys(window.articleDisplayManager.currentArticle));

                            // æª¢æŸ¥å¤šç¨®å¯èƒ½çš„ä½œè€…IDæ¬„ä½
                            authorId = window.articleDisplayManager.currentArticle.memId ||
                                window.articleDisplayManager.currentArticle.mem_id ||
                                window.articleDisplayManager.currentArticle.memberVO?.memId ||
                                window.articleDisplayManager.currentArticle.memberVO?.mem_id ||
                                window.articleDisplayManager.currentArticle.acMemId ||
                                window.articleDisplayManager.currentArticle.ac_mem_id ||
                                window.articleDisplayManager.currentArticle.authorId ||
                                window.articleDisplayManager.currentArticle.author_id;

                            if (authorId) {
                                authorData = window.articleDisplayManager.currentArticle;
                                console.log('âœ… å¾ articleDisplayManager ç²å–åˆ°ä½œè€…ID:', authorId, '(ä¾†æºæ¬„ä½:', Object.keys(window.articleDisplayManager.currentArticle).filter(k => k.toLowerCase().includes('mem') || k.toLowerCase().includes('author')), ')');
                            } else {
                                console.log('âŒ articleDisplayManager.currentArticle ä¸­æ‰¾ä¸åˆ°ä½œè€…IDï¼Œå¯ç”¨æ¬„ä½:', Object.keys(window.articleDisplayManager.currentArticle));
                                console.log('âŒ è©³ç´°æ¬„ä½å€¼æª¢æŸ¥:');
                                console.log('  memId:', window.articleDisplayManager.currentArticle.memId);
                                console.log('  mem_id:', window.articleDisplayManager.currentArticle.mem_id);
                                console.log('  acMemId:', window.articleDisplayManager.currentArticle.acMemId);
                                console.log('  ac_mem_id:', window.articleDisplayManager.currentArticle.ac_mem_id);
                                console.log('  memberVO:', window.articleDisplayManager.currentArticle.memberVO);
                                console.log('  authorId:', window.articleDisplayManager.currentArticle.authorId);
                                console.log('  author_id:', window.articleDisplayManager.currentArticle.author_id);
                            }
                        }

                        // ä¾†æº3: å…¨åŸŸè®Šæ•¸
                        if (!authorData && window.currentArticleAuthorId) {
                            authorId = window.currentArticleAuthorId;
                            authorData = { memId: authorId };
                            console.log('âœ… å¾å…¨åŸŸè®Šæ•¸ç²å–åˆ°ä½œè€…ID:', authorId);
                        }

                        if (authorData && authorId) {
                            console.log('ğŸ¯ æº–å‚™æ›´æ–°æ–‡ç« ä½œè€…é ­åƒï¼Œä½œè€…è³‡æ–™:', authorData);
                            this.updateArticleAuthorAvatar(authorData);
                            avatarUpdated = true; // æ¨™è¨˜å·²æ›´æ–°
                            return true;
                        } else {
                            // æª¢æŸ¥æ˜¯å¦é ­åƒå·²ç¶“è¢«å…¶ä»–åœ°æ–¹æ­£ç¢ºè¨­ç½®äº†
                            const authorAvatarImg = document.querySelector('.author-avatar img');
                            if (authorAvatarImg && authorAvatarImg.src.includes('/member/')) {
                                console.log('âœ… é ­åƒå·²è¢«å…¶ä»–åœ°æ–¹æ­£ç¢ºè¨­ç½®ï¼Œè·³éè¦†è“‹');
                                avatarUpdated = true; // æ¨™è¨˜å·²æ›´æ–°
                                return true;
                            }

                            console.log('âŒ ç„¡æ³•ç²å–æ˜ç¢ºçš„ä½œè€…IDï¼Œé¡¯ç¤ºé è¨­é ­åƒ');
                            // ç„¡æ³•ç²å–ä½œè€…IDæ™‚ï¼Œé¡¯ç¤ºé è¨­çš„user-åœ–ç‰‡
                            this.updateArticleAuthorAvatar(null);
                            avatarUpdated = true; // æ¨™è¨˜å·²æ›´æ–°
                            return true;
                        }
                    }
                    return false;
                };

                // ç«‹å³æª¢æŸ¥ä¸€æ¬¡
                if (checkArticleData() || checkArticleDisplayManager() || checkAuthorNameLoaded()) {
                    console.log('âœ… æ–‡ç« ä½œè€…é ­åƒå·²æ›´æ–°ï¼ˆç«‹å³æª¢æŸ¥ï¼‰');
                    return;
                }

                // è¨­ç½®å®šæœŸæª¢æŸ¥ï¼Œä½†é »ç‡è¼ƒä½
                let checkCount = 0;
                const maxChecks = 200; //æª¢æŸ¥æ¬¡æ•¸
                let intervalId = null;

                const performCheck = () => {
                    checkCount++;

                    if (checkArticleData() || checkArticleDisplayManager() || checkAuthorNameLoaded()) {
                        console.log('âœ… æ–‡ç« ä½œè€…é ­åƒå·²æ›´æ–°');
                        if (intervalId) clearInterval(intervalId);
                        return true;
                    } else if (checkCount >= maxChecks) {
                        console.log('â° æ–‡ç« ä½œè€…é ­åƒç›£è½è¶…æ™‚ï¼Œé¡¯ç¤ºé è¨­é ­åƒ');
                        // è¶…æ™‚æ™‚é¡¯ç¤ºé è¨­é ­åƒï¼Œé¿å…å®Œå…¨æ²’æœ‰é ­åƒ
                        this.updateArticleAuthorAvatar(null);
                        if (intervalId) clearInterval(intervalId);
                        return true;
                    }
                    return false;
                };

                intervalId = setInterval(performCheck, 300); // æ¸›å°‘æª¢æŸ¥é »ç‡è‡³300ms

                // ç›£è½DOMè®ŠåŒ–ï¼ˆæ–‡ç« å…§å®¹å€åŸŸï¼‰ï¼Œä½†åªè§¸ç™¼ä¸€æ¬¡
                const postContent = document.querySelector('.post-content');
                if (postContent) {
                    let domCheckTriggered = false;

                    const observer = new MutationObserver((mutations) => {
                        if (domCheckTriggered) return; // é¿å…é‡è¤‡è§¸ç™¼

                        mutations.forEach((mutation) => {
                            // æª¢æŸ¥æ˜¯å¦æœ‰æ–‡å­—å…§å®¹è®ŠåŒ–ï¼ˆè¡¨ç¤ºæ–‡ç« è¼‰å…¥å®Œæˆï¼‰
                            if (mutation.type === 'childList' || mutation.type === 'characterData') {
                                setTimeout(() => {
                                    if (!domCheckTriggered && (checkArticleData() || checkArticleDisplayManager() || checkAuthorNameLoaded())) {
                                        domCheckTriggered = true;
                                        observer.disconnect();
                                    }
                                }, 500);
                            }
                        });
                    });

                    observer.observe(postContent, {
                        childList: true,
                        subtree: true,
                        characterData: true
                    });

                    // 3ç§’å¾Œè‡ªå‹•åœæ­¢ç›£è½
                    setTimeout(() => {
                        observer.disconnect();
                    }, 3000);
                }

                console.log('âœ… æ–‡ç« ä½œè€…é ­åƒç›£è½å™¨è¨­ç½®å®Œæˆ');
            }

            // åˆå§‹åŒ–UIäº‹ä»¶
            initializeUI() {
                console.log('ğŸ”§ é–‹å§‹åˆå§‹åŒ–UIäº‹ä»¶...');

                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸¦æ§åˆ¶ç•™è¨€è¡¨å–®é¡¯ç¤º
                this.updateCommentFormVisibility();

                // åœ–ç‰‡ä¸Šå‚³æŒ‰éˆ•
                const uploadBtn = document.getElementById('upload-image-btn');
                const fileInput = document.getElementById('image-file-input');
                console.log('ğŸ“¸ åœ–ç‰‡ä¸Šå‚³æŒ‰éˆ•:', uploadBtn ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
                console.log('ğŸ“ æª”æ¡ˆè¼¸å…¥æ¡†:', fileInput ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');

                if (uploadBtn && fileInput) {
                    uploadBtn.addEventListener('click', () => {
                        console.log('ğŸ“¸ åœ–ç‰‡ä¸Šå‚³æŒ‰éˆ•è¢«é»æ“Š');
                        fileInput.click();
                    });
                    fileInput.addEventListener('change', this.handleImageSelect);
                }

                // æ¸…é™¤æ‰€æœ‰åœ–ç‰‡æŒ‰éˆ•
                const clearAllBtn = document.getElementById('clear-all-images');
                console.log('ğŸ—‘ï¸ æ¸…é™¤åœ–ç‰‡æŒ‰éˆ•:', clearAllBtn ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
                if (clearAllBtn) {
                    clearAllBtn.addEventListener('click', () => {
                        console.log('ğŸ—‘ï¸ æ¸…é™¤åœ–ç‰‡æŒ‰éˆ•è¢«é»æ“Š');
                        this.clearAllImages();
                    });
                }

                // æäº¤æŒ‰éˆ•
                const submitBtn = document.getElementById('submit-reply-btn');
                console.log('ğŸ“¤ æäº¤ç•™è¨€æŒ‰éˆ•:', submitBtn ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');

                if (submitBtn) {
                    console.log('âœ… æ­£åœ¨ç¶å®šæäº¤æŒ‰éˆ•äº‹ä»¶...');

                    // æ¸…é™¤æ‰€æœ‰ç¾æœ‰äº‹ä»¶ç›£è½å™¨
                    const newSubmitBtn = submitBtn.cloneNode(true);
                    submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);

                    // åªç¶å®šä¸€å€‹ click äº‹ä»¶ç›£è½å™¨
                    newSubmitBtn.addEventListener('click', (e) => {
                        console.log('ğŸš€ æäº¤æŒ‰éˆ•è¢«é»æ“Šï¼');
                        e.preventDefault();
                        e.stopPropagation();

                        // é˜²æ­¢é‡è¤‡é»æ“Š
                        if (newSubmitBtn.disabled) {
                            console.log('âš ï¸ æŒ‰éˆ•å·²ç¦ç”¨ï¼Œå¿½ç•¥é»æ“Š');
                            return;
                        }

                        this.submitReply();
                    });

                    console.log('âœ… æäº¤æŒ‰éˆ•äº‹ä»¶ç¶å®šå®Œæˆ');
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°æäº¤æŒ‰éˆ•å…ƒç´  #submit-reply-btn');
                }

                // æ’åºé¸å–®
                const sortSelect = document.querySelector('.sort-comments');
                console.log('ğŸ”„ æ’åºé¸å–®:', sortSelect ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
                if (sortSelect) {
                    sortSelect.addEventListener('change', () => {
                        console.log('ğŸ”„ æ’åºé¸å–®è®Šæ›´');
                        // æ’åºæ”¹è®Šæ™‚é‡ç½®åˆ°ç¬¬ä¸€é 
                        this.currentPage = 1;
                        this.renderRepliesSorted(sortSelect.value);
                    });
                }

                // æ‹–æ‹½äº‹ä»¶
                const commentForm = document.querySelector('.comment-form');
                console.log('ğŸ“ ç•™è¨€è¡¨å–®:', commentForm ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
                if (commentForm) {
                    commentForm.addEventListener('dragover', this.handleDragOver);
                    commentForm.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                    commentForm.addEventListener('drop', this.handleDrop);
                }

                // ç²˜è²¼äº‹ä»¶
                const textarea = document.getElementById('reply-textarea');
                console.log('ğŸ“ æ–‡å­—è¼¸å…¥æ¡†:', textarea ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
                if (textarea) {
                    textarea.addEventListener('paste', this.handlePaste);

                    // å‹•æ…‹åœ–ç‰‡æ‹–å…¥æ¡†åŠŸèƒ½ï¼ˆåƒ…åœ¨ç™»å…¥æ™‚é¡¯ç¤ºï¼‰
                    textarea.addEventListener('focus', () => {
                        console.log('ğŸ¯ æ–‡å­—æ¡†ç²å¾—ç„¦é»');
                        this.showDynamicImageUploadArea();
                    });

                    textarea.addEventListener('blur', () => {
                        console.log('ğŸ‘‹ æ–‡å­—æ¡†å¤±å»ç„¦é»');
                        // å»¶é²éš±è—ï¼Œé¿å…é»æ“Šåœ–ç‰‡æ‹–å…¥æ¡†æ™‚ç«‹å³æ¶ˆå¤±
                        setTimeout(() => {
                            this.hideDynamicImageUploadArea();
                        }, 200);
                    });
                }

                // Enter éµæäº¤ï¼ˆCtrl+Enterï¼‰
                if (textarea) {
                    textarea.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && e.ctrlKey) {
                            console.log('âŒ¨ï¸ Ctrl+Enter å¿«æ·éµè§¸ç™¼');
                            e.preventDefault();

                            // é˜²æ­¢é‡è¤‡æäº¤
                            const submitButton = document.getElementById('submit-reply-btn');
                            if (submitButton && !submitButton.disabled) {
                                this.submitReply();
                            }
                        }
                    });
                }

                console.log('ğŸ”§ UIäº‹ä»¶åˆå§‹åŒ–å®Œæˆ');
            }

            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            isUserLoggedIn() {
                const memberData = localStorage.getItem('currentMember') || sessionStorage.getItem('currentMember');
                return !!memberData;
            }

            // æ›´æ–°ç•™è¨€è¡¨å–®å¯è¦‹æ€§
            updateCommentFormVisibility() {
                const isLoggedIn = this.isUserLoggedIn();
                const loginMessage = document.getElementById('login-required-message');
                const commentForm = document.getElementById('comment-form-container');

                if (loginMessage && commentForm) {
                    if (isLoggedIn) {
                        loginMessage.style.display = 'none';
                        commentForm.style.display = 'block';
                    } else {
                        loginMessage.style.display = 'block';
                        commentForm.style.display = 'none';
                    }
                }
            }

            // é¡¯ç¤ºå‹•æ…‹åœ–ç‰‡ä¸Šå‚³å€åŸŸ
            showDynamicImageUploadArea() {
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                if (!this.isUserLoggedIn()) {
                    console.log('ğŸ‘¤ ç”¨æˆ¶æœªç™»å…¥ï¼Œä¸é¡¯ç¤ºåœ–ç‰‡ä¸Šå‚³å€åŸŸ');
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨å‹•æ…‹ä¸Šå‚³å€åŸŸ
                let dynamicUploadArea = document.getElementById('dynamic-image-upload-area');
                if (dynamicUploadArea) {
                    console.log('ğŸ“¸ å‹•æ…‹ä¸Šå‚³å€åŸŸå·²å­˜åœ¨ï¼Œç›´æ¥é¡¯ç¤º');
                    dynamicUploadArea.style.display = 'block';
                    // é‡ç½®æ¨£å¼ä¸¦æ›´æ–°å…§å®¹
                    dynamicUploadArea.style.borderColor = '#007bff';
                    dynamicUploadArea.style.backgroundColor = 'rgba(0, 123, 255, 0.05)';
                    dynamicUploadArea.style.cursor = 'pointer';
                    this.updateDynamicUploadAreaContent(dynamicUploadArea);
                    return;
                }

                console.log('ğŸ“¸ å‰µå»ºå‹•æ…‹åœ–ç‰‡ä¸Šå‚³å€åŸŸ');

                // å‰µå»ºå‹•æ…‹åœ–ç‰‡ä¸Šå‚³å€åŸŸ
                dynamicUploadArea = document.createElement('div');
                dynamicUploadArea.id = 'dynamic-image-upload-area';
                dynamicUploadArea.style.cssText = `
                    margin: 10px 0;
                    padding: 20px;
                    border: 2px dashed #007bff;
                    border-radius: 8px;
                    background: rgba(0, 123, 255, 0.05);
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                `;

                dynamicUploadArea.innerHTML = `
                    <div class="dynamic-upload-content">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #007bff; margin-bottom: 10px; display: block;"></i>
                        <div style="font-size: 1.1rem; color: #333; margin-bottom: 5px; font-weight: 500;">æ‹–æ‹½åœ–ç‰‡åˆ°æ­¤è™•æˆ–é»æ“Šä¸Šå‚³</div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">æ”¯æ´ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤š5å¼µï¼Œæ¯å¼µæœ€å¤§10MB</div>
                        <div style="font-size: 0.8rem; color: #999;">æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥è²¼ä¸Šå‰ªè²¼ç°¿ä¸­çš„åœ–ç‰‡</div>
                        <input type="file" class="dynamic-image-input" multiple accept="image/*" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                    </div>
                `;

                // å°‡å‹•æ…‹ä¸Šå‚³å€åŸŸæ’å…¥åˆ°ç•™è¨€è¡¨å–®ä¸­
                const commentForm = document.querySelector('.comment-form');
                const textarea = document.getElementById('reply-textarea');
                if (commentForm && textarea) {
                    commentForm.insertBefore(dynamicUploadArea, textarea.nextSibling);
                }

                // ç¶å®šäº‹ä»¶
                this.bindDynamicUploadEvents(dynamicUploadArea);

                // æ·»åŠ æ‡¸åœæ•ˆæœ
                dynamicUploadArea.addEventListener('mouseenter', () => {
                    if (this.selectedImages.length < 5) {
                        dynamicUploadArea.style.borderColor = '#0056b3';
                        dynamicUploadArea.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
                    }
                });

                dynamicUploadArea.addEventListener('mouseleave', () => {
                    if (this.selectedImages.length === 0) {
                        dynamicUploadArea.style.borderColor = '#007bff';
                        dynamicUploadArea.style.backgroundColor = 'rgba(0, 123, 255, 0.05)';
                    } else if (this.selectedImages.length < 5) {
                        dynamicUploadArea.style.borderColor = '#28a745';
                        dynamicUploadArea.style.backgroundColor = 'rgba(40, 167, 69, 0.05)';
                    } else {
                        dynamicUploadArea.style.borderColor = '#dc3545';
                        dynamicUploadArea.style.backgroundColor = 'rgba(220, 53, 69, 0.05)';
                    }
                });

                // ç«‹å³æ›´æ–°å…§å®¹ä»¥åæ˜ ç•¶å‰ç‹€æ…‹
                this.updateDynamicUploadAreaContent(dynamicUploadArea);

                console.log('âœ… å‹•æ…‹åœ–ç‰‡ä¸Šå‚³å€åŸŸå‰µå»ºå®Œæˆ');
            }

            // éš±è—å‹•æ…‹åœ–ç‰‡ä¸Šå‚³å€åŸŸ
            hideDynamicImageUploadArea() {
                const dynamicUploadArea = document.getElementById('dynamic-image-upload-area');
                if (dynamicUploadArea) {
                    console.log('ğŸ“¸ éš±è—å‹•æ…‹åœ–ç‰‡ä¸Šå‚³å€åŸŸ');
                    dynamicUploadArea.style.display = 'none';
                }
            }

            // ç¶å®šå‹•æ…‹ä¸Šå‚³å€åŸŸçš„äº‹ä»¶
            bindDynamicUploadEvents(uploadArea) {
                const fileInput = uploadArea.querySelector('.dynamic-image-input');

                // é»æ“Šä¸Šå‚³
                uploadArea.addEventListener('click', (e) => {
                    if (e.target === fileInput) return; // é¿å…é‡è¤‡è§¸ç™¼
                    fileInput.click();
                });

                // æª”æ¡ˆé¸æ“‡äº‹ä»¶
                fileInput.addEventListener('change', (e) => {
                    console.log('ğŸ“¸ å‹•æ…‹ä¸Šå‚³å€åŸŸï¼šé¸æ“‡æª”æ¡ˆ', e.target.files.length, 'å€‹');
                    this.handleImageSelect(e);
                    // é¸æ“‡å®Œæª”æ¡ˆå¾Œä¿æŒé¡¯ç¤ºï¼Œä½†æ›´æ–°å…§å®¹
                    this.updateDynamicUploadAreaContent(uploadArea);
                });

                // æ‹–æ‹½äº‹ä»¶
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#0056b3';
                    uploadArea.style.backgroundColor = 'rgba(0, 123, 255, 0.15)';
                });

                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#007bff';
                    uploadArea.style.backgroundColor = 'rgba(0, 123, 255, 0.05)';
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#007bff';
                    uploadArea.style.backgroundColor = 'rgba(0, 123, 255, 0.05)';

                    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                    if (files.length > 0) {
                        console.log('ğŸ“¸ å‹•æ…‹ä¸Šå‚³å€åŸŸï¼šæ‹–æ‹½æª”æ¡ˆ', files.length, 'å€‹');

                        // æ¨¡æ“¬æª”æ¡ˆé¸æ“‡äº‹ä»¶
                        const dataTransfer = new DataTransfer();
                        files.forEach(file => dataTransfer.items.add(file));
                        fileInput.files = dataTransfer.files;

                        // è§¸ç™¼ change äº‹ä»¶
                        const changeEvent = new Event('change', { bubbles: true });
                        fileInput.dispatchEvent(changeEvent);

                        // æ›´æ–°å‹•æ…‹ä¸Šå‚³å€åŸŸå…§å®¹
                        this.updateDynamicUploadAreaContent(uploadArea);
                    }
                });

                // é˜»æ­¢å‹•æ…‹ä¸Šå‚³å€åŸŸå¤±å»ç„¦é»æ™‚ç«‹å³éš±è—
                uploadArea.addEventListener('mousedown', (e) => {
                    e.preventDefault(); // é˜»æ­¢ textarea å¤±å»ç„¦é»
                });

                uploadArea.addEventListener('mouseup', () => {
                    // é‡æ–°èšç„¦åˆ° textarea
                    const textarea = document.getElementById('reply-textarea');
                    if (textarea) {
                        textarea.focus();
                    }
                });

                console.log('âœ… å‹•æ…‹ä¸Šå‚³å€åŸŸäº‹ä»¶ç¶å®šå®Œæˆ');
            }

            // æ›´æ–°å‹•æ…‹ä¸Šå‚³å€åŸŸå…§å®¹ï¼ˆæ ¹æ“šé¸æ“‡çš„åœ–ç‰‡æ•¸é‡ï¼‰
            updateDynamicUploadAreaContent(uploadArea) {
                const content = uploadArea.querySelector('.dynamic-upload-content');
                if (!content) return;

                const selectedCount = this.selectedImages.length;
                const maxImages = 5;
                const canAddMore = selectedCount < maxImages;

                if (selectedCount === 0) {
                    // æ²’æœ‰é¸æ“‡åœ–ç‰‡ï¼Œé¡¯ç¤ºåˆå§‹ç‹€æ…‹
                    content.innerHTML = `
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #007bff; margin-bottom: 10px; display: block;"></i>
                        <div style="font-size: 1.1rem; color: #333; margin-bottom: 5px; font-weight: 500;">æ‹–æ‹½åœ–ç‰‡åˆ°æ­¤è™•æˆ–é»æ“Šä¸Šå‚³</div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">æ”¯æ´ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤š5å¼µï¼Œæ¯å¼µæœ€å¤§10MB</div>
                        <div style="font-size: 0.8rem; color: #999;">æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥è²¼ä¸Šå‰ªè²¼ç°¿ä¸­çš„åœ–ç‰‡</div>
                        <input type="file" class="dynamic-image-input" multiple accept="image/*" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                    `;
                } else if (canAddMore) {
                    // å·²é¸æ“‡éƒ¨åˆ†åœ–ç‰‡ï¼Œå¯ä»¥ç¹¼çºŒæ·»åŠ 
                    const remainingCount = maxImages - selectedCount;
                    content.innerHTML = `
                        <i class="fas fa-images" style="font-size: 1.8rem; color: #28a745; margin-bottom: 8px; display: block;"></i>
                        <div style="font-size: 1rem; color: #28a745; margin-bottom: 5px; font-weight: 500;">å·²é¸æ“‡ ${selectedCount} å¼µåœ–ç‰‡</div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">é»æ“Šæˆ–æ‹–æ‹½å¯å†æ·»åŠ  ${remainingCount} å¼µåœ–ç‰‡</div>
                        <div style="font-size: 0.8rem; color: #999;">æœ€å¤šç¸½å…±5å¼µåœ–ç‰‡</div>
                        <input type="file" class="dynamic-image-input" multiple accept="image/*" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                    `;

                    // æ›´æ–°æ¨£å¼
                    uploadArea.style.borderColor = '#28a745';
                    uploadArea.style.backgroundColor = 'rgba(40, 167, 69, 0.05)';
                } else {
                    // å·²é”åˆ°æœ€å¤§åœ–ç‰‡æ•¸é‡
                    content.innerHTML = `
                        <i class="fas fa-check-circle" style="font-size: 1.8rem; color: #dc3545; margin-bottom: 8px; display: block;"></i>
                        <div style="font-size: 1rem; color: #dc3545; margin-bottom: 5px; font-weight: 500;">å·²é”ä¸Šé™ (${selectedCount}/5)</div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">å¦‚éœ€æ·»åŠ æ›´å¤šåœ–ç‰‡ï¼Œè«‹å…ˆç§»é™¤éƒ¨åˆ†å·²é¸åœ–ç‰‡</div>
                        <div style="font-size: 0.8rem; color: #999;">æ‚¨å¯ä»¥åœ¨ä¸‹æ–¹é è¦½å€åŸŸç®¡ç†åœ–ç‰‡</div>
                    `;

                    // æ›´æ–°æ¨£å¼
                    uploadArea.style.borderColor = '#dc3545';
                    uploadArea.style.backgroundColor = 'rgba(220, 53, 69, 0.05)';
                    uploadArea.style.cursor = 'not-allowed';
                }

                // é‡æ–°ç¶å®šæª”æ¡ˆè¼¸å…¥äº‹ä»¶
                const newFileInput = uploadArea.querySelector('.dynamic-image-input');
                if (newFileInput && canAddMore) {
                    newFileInput.addEventListener('change', (e) => {
                        console.log('ğŸ“¸ å‹•æ…‹ä¸Šå‚³å€åŸŸï¼šé¸æ“‡æª”æ¡ˆ', e.target.files.length, 'å€‹');
                        this.handleImageSelect(e);
                        this.updateDynamicUploadAreaContent(uploadArea);
                    });
                }

                console.log('âœ… å‹•æ…‹ä¸Šå‚³å€åŸŸå…§å®¹å·²æ›´æ–°ï¼Œç•¶å‰åœ–ç‰‡æ•¸:', selectedCount);
            }
        }

        // å‰µå»ºå…¨åŸŸå¯¦ä¾‹
        let replySystem;

        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸŒŸ DOMè¼‰å…¥å®Œæˆï¼Œé–‹å§‹å‰µå»ºç•™è¨€ç³»çµ±å¯¦ä¾‹...');

            try {
                replySystem = new EnhancedReplySystem();
                console.log('âœ… ç•™è¨€ç³»çµ±å¯¦ä¾‹å‰µå»ºæˆåŠŸ');

                window.replySystem = replySystem; // å…¨åŸŸå­˜å–
                console.log('ğŸŒ ç•™è¨€ç³»çµ±å·²è¨­ç½®ç‚ºå…¨åŸŸè®Šæ•¸');

                // ç¦ç”¨èˆŠçš„ç•™è¨€ç³»çµ±
                window.disableOldReplySystem = true;
                console.log('ğŸš« å·²ç¦ç”¨èˆŠçš„ç•™è¨€ç³»çµ±');

                // è¦†è“‹å¯èƒ½çš„èˆŠç•™è¨€å‡½æ•¸
                window.initComments = function () {
                    console.log('ğŸš« é˜»æ­¢èˆŠç•™è¨€ç³»çµ±åˆå§‹åŒ–');
                    return false;
                };

                window.loadReplies = function () {
                    console.log('ğŸš« é˜»æ­¢èˆŠç•™è¨€ç³»çµ±è¼‰å…¥');
                    return false;
                };

                window.renderReplies = function () {
                    console.log('ğŸš« é˜»æ­¢èˆŠç•™è¨€ç³»çµ±æ¸²æŸ“');
                    return false;
                };

                // ä¿è­·ç•™è¨€å®¹å™¨ä¸è¢«è¦†è“‹
                const protectCommentsList = () => {
                    const commentsList = document.querySelector('.comments-list');
                    if (commentsList) {
                        // æ¨™è¨˜ç‚ºå—ä¿è­·
                        commentsList.setAttribute('data-protected', 'true');

                        // ç›£è½DOMè®ŠåŒ–ï¼Œé˜²æ­¢è¢«è¦†è“‹ï¼ˆé™ä½æ•æ„Ÿåº¦é¿å…ç„¡é™é‡æ¸²æŸ“ï¼‰
                        let lastObserverRender = 0;
                        const OBSERVER_RENDER_COOLDOWN = 3000; // 3ç§’å†·å»æ™‚é–“

                        const observer = new MutationObserver((mutations) => {
                            const now = Date.now();
                            if (now - lastObserverRender < OBSERVER_RENDER_COOLDOWN) {
                                return; // åœ¨å†·å»æœŸé–“ï¼Œå¿½ç•¥è®ŠåŒ–
                            }

                            mutations.forEach((mutation) => {
                                if (mutation.type === 'childList') {
                                    // æ›´åš´æ ¼çš„æª¢æŸ¥æ¢ä»¶ - åªæœ‰ç•¶å…§å®¹å®Œå…¨è¢«æ¸…ç©ºæ™‚æ‰é‡æ–°æ¸²æŸ“
                                    const currentContent = commentsList.innerHTML.trim();
                                    const hasCommentItems = commentsList.querySelector('.comment-item');
                                    const hasEmptyMessage = currentContent.includes('æš«ç„¡ç•™è¨€');

                                    if (!hasCommentItems && !hasEmptyMessage && currentContent.length < 100 &&
                                        replySystem && replySystem.allReplies && replySystem.allReplies.length > 0) {
                                        console.log('ğŸ›¡ï¸ åµæ¸¬åˆ°ç•™è¨€å®Œå…¨éºå¤±ï¼Œé‡æ–°æ¸²æŸ“');
                                        lastObserverRender = now;
                                        setTimeout(() => {
                                            replySystem.renderRepliesSorted();
                                        }, 200);
                                    }
                                }
                            });
                        });

                        observer.observe(commentsList, {
                            childList: true,
                            subtree: false // åªç›£è½ç›´æ¥å­å…ƒç´ è®ŠåŒ–ï¼Œä¸ç›£è½æ·±å±¤è®ŠåŒ–
                        });

                        console.log('ğŸ›¡ï¸ å·²ä¿è­·ç•™è¨€å®¹å™¨');
                    }
                };

                replySystem.init();
                console.log('ğŸš€ ç•™è¨€ç³»çµ±åˆå§‹åŒ–èª¿ç”¨å®Œæˆ');

                // ç›£è½ç™»å…¥ç‹€æ…‹è®ŠåŒ–
                const checkLoginState = () => {
                    if (replySystem) {
                        replySystem.updateCommentFormVisibility();
                    }
                };

                // å®šæœŸæª¢æŸ¥ç™»å…¥ç‹€æ…‹è®ŠåŒ–
                setInterval(checkLoginState, 2000);

                // å»¶é²è¨­ç½®ä¿è­·ï¼Œç¢ºä¿ç•™è¨€å·²è¼‰å…¥
                setTimeout(protectCommentsList, 2000);

                // å®šæœŸæª¢æŸ¥ä¸¦æ¢å¾©å…§å®¹ï¼ˆé™ä½æª¢æŸ¥é »ç‡ä»¥é¿å…ç„¡é™é‡æ–°æ¸²æŸ“ï¼‰
                let lastRenderTime = 0;
                const MIN_RENDER_INTERVAL = 5000; // æœ€å°5ç§’é–“éš”

                const maintainContent = () => {
                    const now = Date.now();
                    if (now - lastRenderTime < MIN_RENDER_INTERVAL) {
                        return; // å¤ªé »ç¹ï¼Œè·³éé€™æ¬¡æª¢æŸ¥
                    }

                    if (replySystem && replySystem.allReplies && replySystem.allReplies.length > 0) {
                        const commentsList = document.querySelector('.comments-list');
                        if (commentsList) {
                            // æ›´åš´æ ¼çš„æª¢æŸ¥æ¢ä»¶ï¼Œé¿å…èª¤åˆ¤
                            const hasCommentItems = commentsList.querySelector('.comment-item');
                            const hasEmptyMessage = commentsList.innerHTML.includes('æš«ç„¡ç•™è¨€');

                            // åªæœ‰ç•¶å®Œå…¨æ²’æœ‰ç•™è¨€é …ç›®ä¸”æ‡‰è©²æœ‰ç•™è¨€æ™‚æ‰é‡æ–°æ¸²æŸ“
                            if (!hasCommentItems && !hasEmptyMessage && replySystem.allReplies.length > 0) {
                                console.log('ğŸ”„ åµæ¸¬åˆ°å…§å®¹å®Œå…¨éºå¤±ï¼Œé‡æ–°æ¸²æŸ“ç•™è¨€');
                                lastRenderTime = now;
                                replySystem.renderRepliesSorted();
                            }
                        }
                    }
                };

                // æ¯10ç§’æª¢æŸ¥ä¸€æ¬¡ï¼ˆé™ä½é »ç‡ï¼‰
                setInterval(maintainContent, 10000);

                // é é¢è¼‰å…¥å®Œæˆå¾Œå¼·åˆ¶æª¢æŸ¥
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        console.log('ğŸ”„ é é¢è¼‰å…¥å®Œæˆï¼Œå¼·åˆ¶é‡æ–°æ¸²æŸ“ç•™è¨€');
                        if (replySystem && replySystem.allReplies && replySystem.allReplies.length > 0) {
                            replySystem.renderRepliesSorted();
                        }

                        // å‚™ç”¨æ©Ÿåˆ¶ï¼šæª¢æŸ¥é ­åƒæ˜¯å¦é¡¯ç¤ºï¼Œå¦‚æœæ²’æœ‰å‰‡é¡¯ç¤ºé è¨­é ­åƒ
                        const authorAvatarImg = document.querySelector('.author-avatar img');
                        if (authorAvatarImg && authorAvatarImg.style.display === 'none') {
                            console.log('ğŸ”§ å‚™ç”¨æ©Ÿåˆ¶ï¼šå¼·åˆ¶é¡¯ç¤ºé è¨­é ­åƒ');
                            if (replySystem) {
                                replySystem.updateArticleAuthorAvatar(null);
                            }
                        }
                    }, 3000);
                });

            } catch (error) {
                console.error('âŒ å‰µå»ºç•™è¨€ç³»çµ±æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                console.error('ğŸ” éŒ¯èª¤å †ç–Š:', error.stack);
            }
        });

        // æä¾›çµ¦å¤–éƒ¨å‘¼å«çš„å‡½æ•¸ï¼ˆå‘å¾Œç›¸å®¹ï¼‰- å·²ç¦ç”¨
        window.setReplyTo = function (floor, content) {
            // å›è¦†åŠŸèƒ½å·²æš«æ™‚ç¦ç”¨
            console.log('ğŸ“ å›è¦†åŠŸèƒ½æš«æ™‚ç¦ç”¨');
            return;
        };

        // æä¾›å¤–éƒ¨æ›´æ–°æ–‡ç« ä½œè€…é ­åƒçš„æ–¹æ³•
        window.updateArticleAuthorAvatar = function (authorData) {
            if (window.replySystem) {
                console.log('ğŸŒ å¤–éƒ¨èª¿ç”¨ï¼šæ›´æ–°æ–‡ç« ä½œè€…é ­åƒ');
                window.replySystem.updateArticleAuthorAvatar(authorData);
            } else {
                console.warn('âš ï¸ ç•™è¨€ç³»çµ±å°šæœªåˆå§‹åŒ–ï¼Œç„¡æ³•æ›´æ–°æ–‡ç« ä½œè€…é ­åƒ');
            }
        };
    </script>
    <script>
        // ç€è¦½æ¬¡æ•¸è™•ç†ï¼ˆçµ±ä¸€è™•ç†ï¼Œé¿å…é‡è¤‡ï¼‰
        document.addEventListener('DOMContentLoaded', function () {
            // ç­‰å¾…æ–‡ç« é¡¯ç¤ºç®¡ç†å™¨è¼‰å…¥å®Œæˆå¾Œè™•ç†ç€è¦½æ¬¡æ•¸
            const checkArticleIdForView = setInterval(() => {
                if (window.articleDisplayManager && window.articleDisplayManager.getCurrentArticleId()) {
                    const acId = window.articleDisplayManager.getCurrentArticleId();
                    // ä½¿ç”¨ ViewCountManager å¦‚æœå­˜åœ¨ï¼Œå¦å‰‡ä½¿ç”¨å…§è¯å‡½æ•¸
                    if (window.ViewCountManager) {
                        window.ViewCountManager.increaseAndShowViewCount(acId);
                    } else {
                        increaseViewCount(acId);
                    }
                    clearInterval(checkArticleIdForView);
                }
            }, 100);

            // å…§è¯ç€è¦½æ¬¡æ•¸å‡½æ•¸ï¼ˆå‚™ç”¨ï¼‰
            async function increaseViewCount(acId) {
                try {
                    const response = await fetch(`${window.api_prefix}/api/articles/${acId}/view`, { method: 'POST' });
                    const result = await response.json();
                    const count = (result.status === 'success') ? result.data : 0;
                    document.querySelectorAll('.view-count').forEach(el => {
                        el.textContent = count.toLocaleString();
                    });
                } catch (error) {
                    console.error('[ViewCount] å¢åŠ ç€è¦½æ¬¡æ•¸å¤±æ•—:', error);
                    document.querySelectorAll('.view-count').forEach(el => {
                        el.textContent = '0';
                    });
                }
            }
        });
    </script>
    <script>
        /* === èª¿è©¦åŠŸèƒ½å·²æš«æ™‚éš±è— === */
        /*
        // åœ–ç‰‡èª¿è©¦åŠŸèƒ½
        function debugImages() {
            console.log('=== åœ–ç‰‡èª¿è©¦é–‹å§‹ ===');
            console.log('API å‰ç¶´:', window.api_prefix);

            // æª¢æŸ¥æ–‡ç« å…§å®¹ä¸­çš„åœ–ç‰‡
            const postBody = document.querySelector('.post-body');
            if (postBody) {
                const images = postBody.querySelectorAll('img');
                console.log('æ‰¾åˆ°åœ–ç‰‡æ•¸é‡:', images.length);

                images.forEach((img, index) => {
                    console.log(`åœ–ç‰‡ ${index + 1}:`);
                    console.log('  - src:', img.src);
                    console.log('  - currentSrc:', img.getAttribute('src'));
                    console.log('  - alt:', img.alt);
                    console.log('  - width:', img.width);
                    console.log('  - height:', img.height);
                    console.log('  - naturalWidth:', img.naturalWidth);
                    console.log('  - naturalHeight:', img.naturalHeight);
                    console.log('  - complete:', img.complete);
                    console.log('  - æ˜¯å¦è¼‰å…¥æˆåŠŸ:', img.naturalWidth > 0);
                });
            } else {
                console.log('æœªæ‰¾åˆ° .post-body å…ƒç´ ');
            }

            // æª¢æŸ¥æ–‡ç« å…§å®¹
            if (postBody) {
                console.log('æ–‡ç« å…§å®¹ HTML:', postBody.innerHTML.substring(0, 500) + '...');
            }

            console.log('=== åœ–ç‰‡èª¿è©¦çµæŸ ===');
        }

        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œèª¿è©¦
        document.addEventListener('DOMContentLoaded', function () {
            // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿æ–‡ç« å…§å®¹å·²è¼‰å…¥
            setTimeout(debugImages, 2000);

            // å»¶é²åŸ·è¡Œåœ–ç‰‡ä¸Šå‚³å»ºè­°æ¸¬è©¦
            setTimeout(testUploadRecommendations, 3000);
        });

        // æ¸¬è©¦åœ–ç‰‡ä¸Šå‚³å»ºè­°åŠŸèƒ½
        async function testUploadRecommendations() {
            try {
                console.log('=== æ¸¬è©¦åœ–ç‰‡ä¸Šå‚³å»ºè­° ===');

                const response = await fetch(`${window.api_prefix}/api/articles/upload-recommendations`);
                const result = await response.json();

                if (result.status === 'success') {
                    console.log('ä¸Šå‚³å»ºè­°ç²å–æˆåŠŸ:', result.data);
                    console.log('Base64 ç­–ç•¥:', result.data.strategies.BASE64);
                    console.log('ç›´æ¥ä¸Šå‚³ç­–ç•¥:', result.data.strategies.DIRECT_UPLOAD);
                    console.log('åˆ†å¡Šä¸Šå‚³ç­–ç•¥:', result.data.strategies.CHUNKED_UPLOAD);
                } else {
                    console.error('ç²å–ä¸Šå‚³å»ºè­°å¤±æ•—:', result);
                }
            } catch (error) {
                console.error('æ¸¬è©¦ä¸Šå‚³å»ºè­°æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // æ¸¬è©¦æ™ºèƒ½ä¸Šå‚³ç­–ç•¥æª¢æŸ¥
        async function testUploadStrategy(fileSize) {
            try {
                console.log(`=== æ¸¬è©¦ä¸Šå‚³ç­–ç•¥æª¢æŸ¥ (æª”æ¡ˆå¤§å°: ${fileSize} bytes) ===`);

                const response = await fetch(`${window.api_prefix}/api/article-images/upload-strategy?fileSize=${fileSize}`);
                const result = await response.json();

                if (result.status === 'success') {
                    console.log('å»ºè­°ç­–ç•¥:', result.data.strategy);
                    console.log('æª”æ¡ˆå¤§å°:', result.data.fileSize);
                    console.log('Base64 ä¸Šé™:', result.data.maxBase64Size, 'bytes');
                    console.log('ç›´æ¥ä¸Šå‚³ä¸Šé™:', result.data.maxDirectSize, 'bytes');
                    return result.data.strategy;
                } else {
                    console.error('ç²å–ä¸Šå‚³ç­–ç•¥å¤±æ•—:', result);
                    return null;
                }
            } catch (error) {
                console.error('æ¸¬è©¦ä¸Šå‚³ç­–ç•¥æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return null;
            }
        }

        // æ·»åŠ åˆ°å…¨åŸŸä¾›æ‰‹å‹•æ¸¬è©¦
        window.testUploadStrategy = testUploadStrategy;
        */
    </script>
    <script>
        // æ–‡ç« å…§å®¹åœ–ç‰‡é»æ“Šæ”¾å¤§ï¼ˆç‡ˆç®±ï¼‰
        function bindArticleImageLightbox() {
            const postBody = document.querySelector('.post-body');
            if (!postBody) return;
            postBody.querySelectorAll('img').forEach(img => {
                img.style.cursor = 'zoom-in';
                img.addEventListener('click', function () {
                    if (window.replySystem && typeof window.replySystem.showImageLightbox === 'function') {
                        window.replySystem.showImageLightbox(this.src);
                    }
                });
            });
        }

        // è‹¥æ–‡ç« å…§å®¹æ˜¯å‹•æ…‹è¼‰å…¥ï¼Œè«‹åœ¨å…§å®¹è¼‰å…¥å¾Œå†å‘¼å«
        // é€™è£¡å…ˆåœ¨ DOMContentLoaded å‘¼å«ä¸€æ¬¡

        document.addEventListener('DOMContentLoaded', function () {
            // è‹¥æ–‡ç« å…§å®¹æ˜¯ AJAX è¼‰å…¥ï¼Œè«‹åœ¨å…§å®¹æ’å…¥å¾Œå†å‘¼å«
            setTimeout(bindArticleImageLightbox, 800); // å»¶é²ç¢ºä¿å…§å®¹å·²è¼‰å…¥
        });
    </script>

</body>

</html>